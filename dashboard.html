<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>ALIF Â· Smart Medical Dashboard</title>
    <!-- Critical CSS inlined for speed -->
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        :root {
            --primary: #60a5fa;
            --primary-dark: #3b82f6;
            --primary-light: #93c5fd;
            --secondary: #94a3b8;
            --success: #22c55e;
            --error: #ef4444;
            --warning: #eab308;
            --info: #0ea5e9;
            --purple: #8b5cf6;
            --pink: #ec4899;
            --orange: #f97316;
            --teal: #14b8a6;
            --gold: #fbbf24;
            --gold-dark: #d97706;
            --premium: linear-gradient(135deg, #8b5cf6, #ec4899);
            --shadow: 0 2px 4px rgba(0, 0, 0, 0.6);
            --radius: 12px;
            --transition: all 0.2s cubic-bezier(0.4, 0, 0.2, 1);
            --gradient: linear-gradient(135deg, #3b82f6 0%, #60a5fa 100%);
        }
        
        .light-mode {
            --background: #f3f4f6;
            --surface: #ffffff;
            --text-primary: #111827;
            --text-secondary: #4b5563;
            --text-tertiary: #9ca3af;
            --border: #d1d5db;
            --card-bg: #ffffff;
        }
        
        .dark-mode {
            --background: #0f172a;
            --surface: #1e293b;
            --text-primary: #f9fafb;
            --text-secondary: #d1d5db;
            --text-tertiary: #6b7280;
            --border: #334155;
            --card-bg: #1e293b;
        }

        body {
            background-color: var(--background);
            color: var(--text-primary);
            transition: background-color 0.2s, color 0.2s;
            min-height: 100vh;
            font-family: 'Inter', sans-serif;
        }

        /* Loading spinner minimal */
        .loading-spinner {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            min-height: 100vh;
            background: var(--background);
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            z-index: 10000;
        }
        
        .spinner {
            width: 40px;
            height: 40px;
            border: 3px solid var(--border);
            border-top-color: var(--primary);
            border-radius: 50%;
            animation: spin 0.6s linear infinite;
        }
        
        @keyframes spin { to { transform: rotate(360deg); } }

        /* Header minimal */
        .app-header {
            position: sticky;
            top: 0;
            z-index: 1000;
            background: var(--surface);
            border-bottom: 1px solid var(--border);
            padding: 0.5rem 1rem;
            backdrop-filter: blur(8px);
        }
        
        .header-container {
            max-width: 1400px;
            margin: 0 auto;
            display: flex;
            align-items: center;
            justify-content: space-between;
        }
        
        .app-title {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            cursor: pointer;
        }
        
        .app-title-icon {
            width: 36px;
            height: 36px;
            background: var(--gradient);
            border-radius: 8px;
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
        }
        
        .app-title-text {
            font-weight: 800;
            font-size: 1.3rem;
            color: var(--text-primary);
        }
        
        .app-title-text span { color: var(--primary); }

        .profile-btn {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            padding: 0.2rem 0.5rem 0.2rem 0.2rem;
            border-radius: 30px;
            background: var(--gradient);
            border: none;
            cursor: pointer;
            transition: transform 0.1s;
        }
        
        .profile-avatar {
            width: 32px;
            height: 32px;
            border-radius: 50%;
            background: white;
            display: flex;
            align-items: center;
            justify-content: center;
            color: var(--primary);
            font-weight: 600;
            position: relative;
        }

        /* Quick CSS for year card */
        .year-card {
            background: var(--card-bg);
            border: 2px solid var(--border);
            border-radius: 20px;
            padding: 1.5rem;
            cursor: pointer;
            transition: transform 0.1s, border-color 0.1s;
            display: flex;
            flex-direction: column;
            min-height: 250px;
        }
        
        .year-card:active { transform: scale(0.98); }

        /* Hide elements until ready */
        [data-hidden] { display: none !important; }
        
        /* Font loading optional - will load async */
    </style>
    <!-- Preload critical assets -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&display=swap" rel="stylesheet">
    <!-- Load Bootstrap async -->
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" media="print" onload="this.media='all'">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" media="print" onload="this.media='all'">
    
    <!-- Firebase - load immediately but non-blocking -->
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js" defer></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-firestore-compat.js" defer></script>
</head>
<body class="dark-mode">
    <!-- Loading Spinner - will be hidden ASAP -->
    <div id="loadingScreen" class="loading-spinner">
        <div class="spinner"></div>
    </div>

    <!-- Main Content (Initially Hidden) -->
    <div id="mainApp" data-hidden="true">
        <header class="app-header">
            <div class="header-container">
                <div class="app-title" id="logoHome">
                    <div class="app-title-icon"><i class="fas fa-stethoscope"></i></div>
                    <div class="app-title-text">ALIF<span>Med</span></div>
                </div>
                
                <button class="profile-btn" id="profileBtn">
                    <div class="profile-avatar" id="profileAvatar"><i class="fas fa-user"></i></div>
                    <div class="profile-info d-none d-md-block">
                        <div class="profile-name" id="profileName">Loading...</div>
                        <div class="profile-role" id="profileRole"></div>
                    </div>
                </button>
            </div>
        </header>

        <div class="container-lg py-3">
            <!-- Hero Section minimal -->
            <div class="bg-primary bg-gradient text-white rounded-4 p-4 mb-4" id="heroSection">
                <h1 class="h3 mb-1" id="heroTitle">Welcome Back!</h1>
                <p class="mb-0 opacity-75" id="heroSubtitle"></p>
            </div>

            <!-- Years Container -->
            <div id="yearsContainer"></div>
        </div>
    </div>

    <script>
        // ===== ULTRA-FAST DASHBOARD =====
        // Configuration
        const firebaseConfig = {
            apiKey: "AIzaSyC4DSMVg4c98kQf5sSF8ueD631QgO4SXn0",
            authDomain: "medical-quiz-40228.firebaseapp.com",
            projectId: "medical-quiz-40228",
            storageBucket: "medical-quiz-40228.firebasestorage.app",
            messagingSenderId: "483043078873",
            appId: "1:483043078873:web:4029dd83e53557f08b04c8"
        };

        // Initialize Firebase immediately
        firebase.initializeApp(firebaseConfig);
        const db = firebase.firestore();
        
        // Enable persistence silently
        db.enablePersistence({ synchronizeTabs: true }).catch(() => {});

        // ===== CACHE KEYS =====
        const CACHE_KEY = 'dashboard_v3';
        const RECENT_KEY = 'recent_years_v3';
        const USER_KEY = 'currentUser';

        // ===== MAIN DASHBOARD =====
        class FastDashboard {
            constructor() {
                this.userData = null;
                this.registeredYears = [];
                this.recentYears = [];
                this.yearsData = {
                    '1': { title: "First Year", icon: "fa-dna", quizzes: 180, questions: 3200 },
                    '2': { title: "Second Year", icon: "fa-vial", quizzes: 210, questions: 3800 },
                    '3': { title: "Third Year", icon: "fa-heartbeat", quizzes: 250, questions: 4500 },
                    '4': { title: "Fourth Year", icon: "fa-stethoscope", quizzes: 220, questions: 4000 },
                    '5': { title: "Fifth Year", icon: "fa-user-md", quizzes: 190, questions: 3500 },
                    '6': { title: "Sixth Year", icon: "fa-book-medical", quizzes: 280, questions: 5200 }
                };
            }

            // Start instantly
            async start() {
                // Check login - immediate redirect if not logged in
                const stored = localStorage.getItem(USER_KEY);
                if (!stored) {
                    window.location.replace('register.html');
                    return;
                }

                this.userData = JSON.parse(stored);
                
                // Try to load from cache first (instant display)
                const cached = this.loadCache();
                if (cached) {
                    this.userData = { ...this.userData, ...cached.userData };
                    this.registeredYears = cached.registeredYears || [];
                    this.recentYears = cached.recentYears || [];
                    this.renderInitial();
                }

                // Hide loading screen immediately
                document.getElementById('loadingScreen').style.display = 'none';
                document.getElementById('mainApp').removeAttribute('data-hidden');

                // Check for single year - INSTANT REDIRECT
                const years = this.getRegisteredYearsFromData();
                if (years.length === 1) {
                    const year = years[0];
                    this.addToRecentYears(year);
                    window.location.replace(`year${year}.html`);
                    return;
                }

                // Load recent years from storage
                this.loadRecentYears();
                
                // Render dashboard (with cache first, then update)
                this.renderFull();
                
                // Try to fetch fresh data in background
                this.fetchFreshData();
                
                // Setup network listeners
                this.setupNetworkListeners();
            }

            getRegisteredYearsFromData() {
                // Extract years from userData (handles multiple formats)
                return (this.userData.registeredYears || [])
                    .map(y => y.toString())
                    .filter(y => y >= '1' && y <= '6');
            }

            loadCache() {
                try {
                    const cached = localStorage.getItem(CACHE_KEY);
                    return cached ? JSON.parse(cached) : null;
                } catch {
                    return null;
                }
            }

            saveCache() {
                try {
                    localStorage.setItem(CACHE_KEY, JSON.stringify({
                        userData: this.userData,
                        registeredYears: this.registeredYears,
                        recentYears: this.recentYears,
                        timestamp: Date.now()
                    }));
                } catch {}
            }

            loadRecentYears() {
                try {
                    const stored = localStorage.getItem(RECENT_KEY);
                    if (stored) {
                        this.recentYears = JSON.parse(stored);
                        // Filter to only years user has access to
                        const validYears = this.getRegisteredYearsFromData();
                        this.recentYears = this.recentYears.filter(y => validYears.includes(y));
                        this.saveRecentYears();
                    }
                } catch {
                    this.recentYears = [];
                }
            }

            saveRecentYears() {
                try {
                    localStorage.setItem(RECENT_KEY, JSON.stringify(this.recentYears));
                } catch {}
            }

            addToRecentYears(year) {
                const yearStr = year.toString();
                this.recentYears = [yearStr, ...this.recentYears.filter(y => y !== yearStr)].slice(0, 5);
                this.saveRecentYears();
                localStorage.setItem(`year_${year}_last`, Date.now().toString());
            }

            // Initial minimal render (from cache)
            renderInitial() {
                const years = this.getRegisteredYearsFromData();
                if (years.length === 0) return;
                
                document.getElementById('profileName').textContent = 
                    this.userData.name?.split(' ')[0] || 'Student';
                
                document.getElementById('heroTitle').textContent = 
                    `Welcome back, ${this.userData.name?.split(' ')[0] || 'Student'}!`;
            }

            // Full render with years grid
            renderFull() {
                const years = this.getRegisteredYearsFromData();
                
                if (years.length === 0) {
                    this.renderNoAccess();
                    return;
                }

                if (years.length === 1) return; // Should have redirected

                // Update profile
                const name = this.userData.name?.split(' ')[0] || 'Student';
                document.getElementById('profileName').textContent = name;
                document.getElementById('profileRole').textContent = `${years.length} Years`;
                
                // Update avatar
                const avatar = document.getElementById('profileAvatar');
                avatar.innerHTML = this.userData.name?.charAt(0).toUpperCase() || 'U';
                
                // Update hero
                document.getElementById('heroTitle').textContent = `Welcome back, ${name}!`;
                document.getElementById('heroSubtitle').textContent = 
                    `Access to ${years.length} year${years.length > 1 ? 's' : ''}`;

                // Render years grid
                this.renderYearsGrid(years);
            }

            renderYearsGrid(years) {
                const container = document.getElementById('yearsContainer');
                
                // Add recent years section if any
                let recentHtml = '';
                if (this.recentYears.length > 0) {
                    const recentItems = this.recentYears
                        .filter(y => years.includes(y))
                        .map(y => {
                            const data = this.yearsData[y];
                            return `
                                <div class="d-flex align-items-center gap-3 p-3 bg-surface rounded-3 border mb-2" 
                                     onclick="dashboard.goToYear('${y}')" style="cursor: pointer">
                                    <div class="bg-primary bg-gradient rounded-2 p-3 text-white">
                                        <i class="fas ${data.icon}"></i>
                                    </div>
                                    <div class="flex-grow-1">
                                        <h4 class="h6 mb-1">Year ${y}: ${data.title}</h4>
                                        <small class="text-secondary">${data.quizzes} quizzes</small>
                                    </div>
                                    <i class="fas fa-chevron-right text-secondary"></i>
                                </div>
                            `;
                        }).join('');
                    
                    if (recentItems) {
                        recentHtml = `
                            <div class="mb-4">
                                <h3 class="h5 mb-3"><i class="fas fa-history me-2 text-primary"></i>Recent Years</h3>
                                ${recentItems}
                            </div>
                        `;
                    }
                }

                // Years grid
                const gridHtml = years.map(year => {
                    const data = this.yearsData[year];
                    return `
                        <div class="year-card mb-3" onclick="dashboard.goToYear('${year}')">
                            <div class="d-flex align-items-center gap-3 mb-3">
                                <div class="bg-primary bg-gradient rounded-3 p-3 text-white">
                                    <i class="fas ${data.icon} fs-4"></i>
                                </div>
                                <div>
                                    <h3 class="h5 mb-1">Year ${year}</h3>
                                    <p class="text-secondary small mb-0">${data.title}</p>
                                </div>
                            </div>
                            <div class="d-flex justify-content-between text-secondary small">
                                <span><i class="fas fa-file-alt me-1"></i>${data.quizzes} quizzes</span>
                                <span><i class="fas fa-question-circle me-1"></i>${data.questions} Qs</span>
                            </div>
                        </div>
                    `;
                }).join('');

                container.innerHTML = `
                    ${recentHtml}
                    <h3 class="h5 mb-3"><i class="fas fa-graduation-cap me-2 text-primary"></i>Your Years</h3>
                    <div class="row g-3">
                        ${gridHtml}
                    </div>
                `;
            }

            renderNoAccess() {
                document.getElementById('yearsContainer').innerHTML = `
                    <div class="text-center p-5 bg-surface rounded-4 border">
                        <i class="fas fa-lock fa-3x text-secondary mb-3"></i>
                        <h3 class="h5">No Program Access</h3>
                        <p class="text-secondary small mb-3">Please contact support to purchase access.</p>
                        <button class="btn btn-primary" onclick="window.location.href='profile.html'">
                            <i class="fas fa-headset me-2"></i>Contact Support
                        </button>
                    </div>
                `;
            }

            goToYear(year) {
                this.addToRecentYears(year);
                window.location.href = `year${year}.html`;
            }

            async fetchFreshData() {
                if (!navigator.onLine) return;
                
                try {
                    const doc = await db.collection('users').doc(this.userData.id).get();
                    if (doc.exists) {
                        const freshData = doc.data();
                        this.userData = { ...this.userData, ...freshData };
                        this.registeredYears = (freshData.registeredYears || []).map(y => y.toString());
                        
                        // Update localStorage
                        localStorage.setItem(USER_KEY, JSON.stringify(this.userData));
                        
                        // Save to cache
                        this.saveCache();
                        
                        // Re-render if still on dashboard
                        const years = this.getRegisteredYearsFromData();
                        if (years.length === 1) {
                            this.addToRecentYears(years[0]);
                            window.location.replace(`year${years[0]}.html`);
                        } else if (years.length > 1) {
                            this.renderFull();
                        }
                    }
                } catch (error) {
                    console.log('Background fetch failed, using cache');
                }
            }

            setupNetworkListeners() {
                window.addEventListener('online', () => {
                    this.fetchFreshData();
                });
            }
        }

        // ===== INSTANT START =====
        let dashboard;
        
        // Execute immediately
        (function init() {
            dashboard = new FastDashboard();
            dashboard.start();

            // Setup theme (lightweight)
            const savedTheme = localStorage.getItem('theme') || 'dark';
            document.body.className = savedTheme + '-mode';
            
            // Logo click
            document.getElementById('logoHome').addEventListener('click', () => {
                window.scrollTo({ top: 0, behavior: 'smooth' });
            });

            // Profile click
            document.getElementById('profileBtn').addEventListener('click', () => {
                window.location.href = 'profile.html';
            });
        })();

        // Expose dashboard globally for onclick handlers
        window.dashboard = dashboard;
    </script>

    <!-- Load non-critical JS async -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js" defer></script>
</body>
</html>
