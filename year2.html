<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>ALIF Â· Bootstrap medical quiz</title>
    <!-- Bootstrap 5 + Icons + Fonts -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800;900&display=swap" rel="stylesheet">
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-firestore-compat.js"></script>
    <style>
        * { font-family: 'Inter', sans-serif; margin: 0; padding: 0; box-sizing: border-box; }
        
        :root {
            --primary: #60a5fa;
            --primary-dark: #3b82f6;
            --primary-light: #93c5fd;
            --secondary: #94a3b8;
            --success: #22c55e;
            --error: #ef4444;
            --warning: #eab308;
            --info: #0ea5e9;
            --purple: #8b5cf6;
            --pink: #ec4899;
            --gold: #fbbf24;
            --gold-dark: #d97706;
            --premium: linear-gradient(135deg, #8b5cf6, #ec4899);
            --shadow: 0 2px 4px rgba(0, 0, 0, 0.6);
            --radius: 12px;
            --transition: all 0.25s cubic-bezier(0.4, 0, 0.2, 1);
            --gradient: linear-gradient(135deg, #3b82f6 0%, #60a5fa 100%);
            --skeleton-base: #e2e8f0;
            --skeleton-highlight: #edf2f7;
        }
        
        .light-mode {
            --background: #f3f4f6;
            --surface: #ffffff;
            --text-primary: #111827;
            --text-secondary: #4b5563;
            --text-tertiary: #9ca3af;
            --border: #d1d5db;
            --placeholder: #9ca3af;
            --input-bg: #ffffff;
            --hover-bg: rgba(96, 165, 250, 0.05);
            --skeleton-base: #e2e8f0;
            --skeleton-highlight: #edf2f7;
        }
        
        .dark-mode {
            --background: #0f172a;
            --surface: #1e293b;
            --text-primary: #f9fafb;
            --text-secondary: #d1d5db;
            --text-tertiary: #6b7280;
            --border: #334155;
            --placeholder: #6b7280;
            --input-bg: #0f172a;
            --hover-bg: rgba(96, 165, 250, 0.1);
            --skeleton-base: #1e293b;
            --skeleton-highlight: #2d3a4f;
        }

        body {
            background-color: var(--background);
            color: var(--text-primary);
            transition: var(--transition);
            min-height: 100vh;
        }

        /* Connection Status */
        .connection-status {
            position: fixed;
            top: 70px;
            right: 20px;
            padding: 0.5rem 1rem;
            border-radius: var(--radius);
            font-size: 0.8rem;
            font-weight: 600;
            z-index: 9999;
            display: flex;
            align-items: center;
            gap: 0.5rem;
            transition: var(--transition);
            backdrop-filter: blur(10px);
            box-shadow: var(--shadow);
        }
        .connection-status.online {
            background: var(--success);
            color: white;
        }
        .connection-status.offline {
            background: var(--error);
            color: white;
        }
        .connection-status.syncing {
            background: var(--warning);
            color: white;
        }

        /* Offline Indicator */
        .offline-indicator {
            position: fixed;
            bottom: 20px;
            left: 20px;
            background: var(--surface);
            border: 1px solid var(--border);
            border-radius: var(--radius);
            padding: 0.5rem 1rem;
            font-size: 0.8rem;
            display: flex;
            align-items: center;
            gap: 0.5rem;
            box-shadow: var(--shadow);
            z-index: 9998;
            backdrop-filter: blur(10px);
        }

        /* Premium Crown on Avatar */
        .premium-crown {
            position: absolute;
            top: -12px;
            right: -8px;
            font-size: 1.2rem;
            filter: drop-shadow(0 4px 6px rgba(0,0,0,0.3));
            animation: crownFloat 3s ease-in-out infinite;
            z-index: 10;
        }
        
        @keyframes crownFloat {
            0%, 100% { transform: translateY(0) rotate(0deg); }
            50% { transform: translateY(-3px) rotate(5deg); }
        }
        
        .premium-crown i {
            background: linear-gradient(135deg, #FFD700, #FFA500);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
        }

        /* Gold Badge */
        .gold-badge {
            background: linear-gradient(135deg, #fbbf24, #f59e0b);
            color: white;
            padding: 0.25rem 1rem;
            border-radius: 30px;
            font-size: 0.7rem;
            font-weight: 600;
            display: inline-flex;
            align-items: center;
            gap: 0.3rem;
            box-shadow: 0 2px 10px rgba(245, 158, 11, 0.5);
            animation: pulse 2s infinite;
        }
        
        @keyframes pulse {
            0%, 100% { transform: scale(1); }
            50% { transform: scale(1.05); }
        }

        /* Custom Header */
        .app-header {
            position: sticky;
            top: 0;
            z-index: 1000;
            background: var(--surface);
            border-bottom: 1px solid var(--border);
            padding: 0.75rem 1rem;
            backdrop-filter: blur(10px);
            -webkit-backdrop-filter: blur(10px);
        }
        
        .header-container {
            max-width: 1400px;
            margin: 0 auto;
            display: flex;
            align-items: center;
            justify-content: space-between;
            gap: 1rem;
        }
        
        .header-left {
            display: flex;
            align-items: center;
            gap: 0.75rem;
        }
        
        .back-btn {
            width: 40px;
            height: 40px;
            border-radius: 12px;
            background: var(--gradient);
            border: none;
            color: white;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            transition: var(--transition);
            box-shadow: 0 4px 10px rgba(59, 130, 246, 0.3);
            position: relative;
            overflow: hidden;
        }
        
        .back-btn::before {
            content: '';
            position: absolute;
            top: 50%;
            left: 50%;
            width: 0;
            height: 0;
            border-radius: 50%;
            background: rgba(255, 255, 255, 0.3);
            transform: translate(-50%, -50%);
            transition: width 0.4s, height 0.4s;
        }
        
        .back-btn:hover::before {
            width: 100px;
            height: 100px;
        }
        
        .back-btn:hover {
            transform: scale(1.05);
        }
        
        .app-title {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            cursor: pointer;
        }
        
        .app-title-icon {
            width: 36px;
            height: 36px;
            background: var(--gradient);
            border-radius: 10px;
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-size: 1.2rem;
        }
        
        .app-title-text {
            font-weight: 700;
            font-size: 1.2rem;
            color: var(--text-primary);
        }
        
        .app-title-text span {
            color: var(--primary);
        }
        
        .header-right {
            display: flex;
            align-items: center;
            gap: 0.75rem;
        }
        
        .theme-toggle-header {
            width: 40px;
            height: 40px;
            border-radius: 12px;
            background: var(--background);
            border: 1px solid var(--border);
            color: var(--text-secondary);
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            transition: var(--transition);
        }
        
        .theme-toggle-header:hover {
            background: var(--primary-light);
            color: var(--primary);
            border-color: var(--primary);
            transform: translateY(-2px);
        }
        
        .profile-btn {
            display: flex;
            align-items: center;
            gap: 0.75rem;
            padding: 0.25rem 0.5rem 0.25rem 0.25rem;
            border-radius: 40px;
            background: var(--gradient);
            border: none;
            cursor: pointer;
            transition: var(--transition);
            box-shadow: 0 4px 10px rgba(59, 130, 246, 0.3);
            position: relative;
        }
        
        .profile-btn:hover {
            transform: scale(1.02);
        }
        
        .profile-avatar {
            width: 36px;
            height: 36px;
            border-radius: 50%;
            background: white;
            display: flex;
            align-items: center;
            justify-content: center;
            color: var(--primary);
            font-size: 1.1rem;
            font-weight: 600;
            position: relative;
        }
        
        .profile-info {
            display: none;
            color: white;
            text-align: left;
        }
        
        @media (min-width: 768px) {
            .profile-info {
                display: block;
                padding-right: 0.5rem;
            }
            
            .profile-name {
                font-size: 0.85rem;
                font-weight: 600;
                line-height: 1.2;
            }
            
            .profile-role {
                font-size: 0.7rem;
                opacity: 0.8;
            }
        }
        
        /* Skeleton Loaders */
        .skeleton-container {
            padding: 1rem;
        }
        
        .skeleton-header {
            width: 100%;
            height: 120px;
            background: linear-gradient(90deg, 
                var(--skeleton-base) 25%, 
                var(--skeleton-highlight) 50%, 
                var(--skeleton-base) 75%);
            background-size: 200% 100%;
            animation: loading 1.5s infinite;
            border-radius: 20px;
            margin-bottom: 2rem;
        }
        
        .skeleton-search {
            width: 100%;
            height: 50px;
            background: linear-gradient(90deg, 
                var(--skeleton-base) 25%, 
                var(--skeleton-highlight) 50%, 
                var(--skeleton-base) 75%);
            background-size: 200% 100%;
            animation: loading 1.5s infinite;
            border-radius: 50px;
            margin-bottom: 2rem;
        }
        
        .skeleton-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 1.5rem;
        }
        
        .skeleton-card {
            background: linear-gradient(90deg, 
                var(--skeleton-base) 25%, 
                var(--skeleton-highlight) 50%, 
                var(--skeleton-base) 75%);
            background-size: 200% 100%;
            animation: loading 1.5s infinite;
            height: 300px;
            border-radius: 20px;
        }
        
        @keyframes loading {
            0% { background-position: 200% 0; }
            100% { background-position: -200% 0; }
        }
        
        /* Gradient Header */
        .gradient-header { 
            background: var(--gradient);
            color: white; 
            box-shadow: var(--shadow);
            margin-top: 1rem;
        }

        /* Search Styles */
        .search-container {
            position: relative;
            width: 100%;
        }
        
        .main-search-wrapper {
            background: var(--surface);
            border: 2px solid var(--border);
            border-radius: 50px;
            transition: var(--transition);
            overflow: hidden;
        }
        
        .main-search-wrapper:focus-within {
            border-color: var(--primary);
            box-shadow: 0 0 0 4px rgba(96, 165, 250, 0.2);
        }
        
        .main-search-input {
            background: transparent !important;
            color: var(--text-primary) !important;
            font-size: 1rem;
            padding: 0.75rem 1rem;
            border: none;
            outline: none;
            width: 100%;
        }
        
        .main-search-input::placeholder {
            color: var(--placeholder);
            opacity: 0.8;
        }
        
        .search-icon-wrapper {
            background: transparent;
            border: none;
            padding: 0 1rem 0 1.5rem;
            color: var(--text-tertiary);
        }

        /* Mini Search */
        .mini-search-container {
            position: relative;
            width: 100%;
            padding: 0.5rem;
            border-bottom: 1px solid var(--border);
            background: var(--surface);
        }
        
        .mini-search-wrapper {
            position: relative;
            width: 100%;
        }
        
        .mini-search-input {
            width: 100%;
            padding: 0.6rem 1rem;
            border-radius: 50px;
            border: 2px solid var(--border);
            background: var(--input-bg);
            color: var(--text-primary);
            font-size: 0.9rem;
            transition: var(--transition);
        }
        
        .mini-search-input:focus {
            outline: none;
            border-color: var(--primary);
            box-shadow: 0 0 0 3px rgba(96, 165, 250, 0.2);
            background: var(--surface);
        }
        
        .dark-mode .mini-search-input {
            background: var(--background);
        }
        
        .dark-mode .mini-search-input:focus {
            background: var(--surface);
        }
        
        .mini-autocomplete-hint {
            position: absolute;
            right: 40px;
            top: 50%;
            transform: translateY(-50%);
            color: var(--text-tertiary);
            font-size: 0.75rem;
            background: var(--surface);
            padding: 0.2rem 0.6rem;
            border-radius: 30px;
            border: 1px solid var(--border);
            pointer-events: none;
            opacity: 0;
            transition: opacity 0.2s;
            display: flex;
            align-items: center;
            gap: 0.2rem;
            z-index: 5;
        }
        
        .mini-autocomplete-hint.show {
            opacity: 1;
        }
        
        .mini-autocomplete-hint i {
            color: var(--primary);
            font-size: 0.7rem;
        }
        
        .mini-autocomplete-dropdown {
            position: absolute;
            top: 100%;
            left: 0;
            right: 0;
            background: var(--surface);
            border: 2px solid var(--border);
            border-radius: 20px;
            max-height: 300px;
            overflow-y: auto;
            z-index: 1000;
            box-shadow: 0 15px 35px rgba(0, 0, 0, 0.3);
            display: none;
            margin-top: 8px;
            padding: 0.5rem;
        }
        
        .mini-autocomplete-dropdown.show {
            display: block;
            animation: slideDown 0.2s ease-out;
        }
        
        .mini-autocomplete-item {
            padding: 0.6rem 1rem;
            cursor: pointer;
            transition: var(--transition);
            border-radius: 12px;
            margin-bottom: 0.25rem;
            display: flex;
            align-items: center;
            gap: 0.75rem;
        }
        
        .mini-autocomplete-item:hover {
            background: var(--hover-bg);
        }
        
        .mini-autocomplete-item.selected {
            background: rgba(96, 165, 250, 0.2);
            border-left: 4px solid var(--primary);
        }
        
        .mini-autocomplete-icon {
            width: 32px;
            height: 32px;
            border-radius: 8px;
            background: var(--gradient);
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-size: 0.9rem;
        }
        
        .mini-autocomplete-content {
            flex: 1;
        }
        
        .mini-autocomplete-title {
            font-weight: 600;
            font-size: 0.85rem;
            color: var(--text-primary);
        }
        
        .mini-autocomplete-subtitle {
            font-size: 0.7rem;
            color: var(--text-tertiary);
            margin-top: 0.1rem;
        }
        
        .mini-autocomplete-badge {
            padding: 0.15rem 0.5rem;
            border-radius: 30px;
            font-size: 0.65rem;
            font-weight: 600;
        }
        
        .mini-autocomplete-badge.exam {
            background: rgba(239, 68, 68, 0.15);
            color: #ef4444;
        }
        
        .mini-autocomplete-badge.practice {
            background: rgba(34, 197, 94, 0.15);
            color: #22c55e;
        }
        
        .mini-autocomplete-badge.quizlet {
            background: rgba(139, 92, 246, 0.15);
            color: #8b5cf6;
        }
        
        .mini-autocomplete-category {
            font-size: 0.65rem;
            padding: 0.2rem 0.6rem;
            background: var(--border);
            border-radius: 30px;
            color: var(--text-secondary);
            font-weight: 500;
        }

        /* Autocomplete Dropdown */
        .autocomplete-dropdown {
            position: absolute;
            top: 100%;
            left: 0;
            right: 0;
            background: var(--surface);
            border: 2px solid var(--border);
            border-radius: 20px;
            max-height: 400px;
            overflow-y: auto;
            z-index: 1000;
            box-shadow: 0 15px 35px rgba(0, 0, 0, 0.3);
            display: none;
            margin-top: 10px;
            padding: 0.5rem;
        }
        
        .autocomplete-dropdown.show {
            display: block;
            animation: slideDown 0.2s ease-out;
        }
        
        .autocomplete-item {
            padding: 0.75rem 1rem;
            cursor: pointer;
            transition: var(--transition);
            border-radius: 12px;
            margin-bottom: 0.25rem;
            display: flex;
            align-items: center;
            gap: 0.75rem;
        }
        
        .autocomplete-item:hover {
            background: var(--hover-bg);
        }
        
        .autocomplete-item.selected {
            background: rgba(96, 165, 250, 0.2);
            border-left: 4px solid var(--primary);
        }
        
        .autocomplete-icon {
            width: 36px;
            height: 36px;
            border-radius: 10px;
            background: var(--gradient);
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-size: 1rem;
        }
        
        .autocomplete-content {
            flex: 1;
        }
        
        .autocomplete-title {
            font-weight: 600;
            font-size: 0.95rem;
            color: var(--text-primary);
        }
        
        .autocomplete-subtitle {
            font-size: 0.8rem;
            color: var(--text-tertiary);
            display: flex;
            gap: 1rem;
            margin-top: 0.2rem;
        }
        
        .autocomplete-match {
            background: rgba(96, 165, 250, 0.3);
            color: var(--primary);
            font-weight: 700;
            padding: 0 2px;
            border-radius: 4px;
        }
        
        .autocomplete-hint {
            position: absolute;
            right: 50px;
            top: 50%;
            transform: translateY(-50%);
            color: var(--text-tertiary);
            font-size: 0.8rem;
            background: var(--surface);
            padding: 0.25rem 0.75rem;
            border-radius: 30px;
            border: 1px solid var(--border);
            pointer-events: none;
            opacity: 0;
            transition: opacity 0.2s;
            display: flex;
            align-items: center;
            gap: 0.3rem;
            z-index: 10;
        }
        
        .autocomplete-hint.show {
            opacity: 1;
        }
        
        .autocomplete-hint i {
            color: var(--primary);
            font-size: 0.75rem;
        }

        .global-search-count {
            background: var(--primary);
            color: white;
            padding: 0.25rem 0.75rem;
            border-radius: 30px;
            font-size: 0.8rem;
            font-weight: 500;
            margin-right: 0.5rem;
        }

        /* Subject Cards */
        .subject-card { 
            background-color: var(--surface); 
            border: 2px solid var(--border); 
            transition: var(--transition); 
            height: 100%; 
            display: flex; 
            flex-direction: column; 
            border-radius: var(--radius);
            overflow: hidden;
        }
        
        .subject-card:hover { 
            transform: translateY(-5px); 
            border-color: var(--primary); 
            box-shadow: 0 15px 30px rgba(0,0,0,0.2);
        }

        .badge-exam { 
            background: linear-gradient(135deg, #ef4444 0%, #dc2626 100%);
            color: white; 
        }
        
        .badge-practice { 
            background: linear-gradient(135deg, #22c55e 0%, #16a34a 100%);
            color: white; 
        }
        
        .badge-quizlet { 
            background: linear-gradient(135deg, #8b5cf6 0%, #ec4899 100%);
            color: white; 
        }

        .stat-card { 
            background: rgba(255,255,255,0.15); 
            border-radius: 20px; 
            padding: 0.4rem 1rem; 
            text-align: center; 
        }
        
        .stat-value { 
            font-size: 1.6rem; 
            font-weight: 700; 
            line-height: 1.2; 
        }

        .mini-filters {
            display: flex;
            gap: 0.3rem;
            padding: 0.5rem;
            border-bottom: 1px solid var(--border);
            flex-wrap: wrap;
            background: var(--surface);
        }
        
        .mini-filter-btn {
            padding: 0.25rem 0.75rem;
            border-radius: 30px;
            border: 2px solid var(--border);
            background: transparent;
            color: var(--text-secondary);
            font-size: 0.75rem;
            cursor: pointer;
            transition: var(--transition);
            display: flex;
            align-items: center;
            gap: 0.3rem;
            font-weight: 500;
        }
        
        .mini-filter-btn:hover {
            background: var(--primary-light);
            color: var(--primary-dark);
            border-color: var(--primary);
            transform: translateY(-1px);
        }
        
        .mini-filter-btn.active {
            background: var(--gradient);
            color: white;
            border-color: transparent;
        }

        .mini-sort {
            padding: 0.5rem;
            border-bottom: 1px solid var(--border);
            background: var(--surface);
        }
        
        .mini-sort-select {
            width: 100%;
            padding: 0.5rem 1rem;
            border-radius: 30px;
            border: 2px solid var(--border);
            background: var(--input-bg);
            color: var(--text-primary);
            font-size: 0.8rem;
            cursor: pointer;
            transition: var(--transition);
            font-weight: 500;
        }
        
        .mini-sort-select:focus {
            outline: none;
            border-color: var(--primary);
            box-shadow: 0 0 0 3px rgba(96, 165, 250, 0.2);
        }

        .search-stats {
            padding: 0.4rem 0.75rem;
            font-size: 0.75rem;
            color: var(--text-tertiary);
            border-bottom: 1px solid var(--border);
            display: flex;
            justify-content: space-between;
            align-items: center;
            background: rgba(96, 165, 250, 0.05);
        }
        
        .clear-search {
            color: var(--primary);
            cursor: pointer;
            font-size: 0.7rem;
            font-weight: 600;
            padding: 0.2rem 0.5rem;
            border-radius: 30px;
            background: rgba(96, 165, 250, 0.1);
            transition: var(--transition);
        }
        
        .clear-search:hover {
            background: rgba(96, 165, 250, 0.2);
        }

        .quiz-list { 
            max-height: 350px; 
            overflow-y: auto; 
            scrollbar-width: thin; 
            padding: 0.5rem;
        }
        
        .quiz-list.expanded { 
            max-height: 700px; 
        }
        
        .quiz-item { 
            border-radius: var(--radius); 
            transition: var(--transition); 
            margin-bottom: 0.25rem;
        }
        
        .quiz-item:hover { 
            background-color: rgba(96, 165, 250, 0.1); 
            transform: translateX(5px); 
        }
        
        .quiz-link { 
            text-decoration: none; 
            color: var(--text-primary); 
            display: flex; 
            align-items: center; 
            justify-content: space-between; 
            padding: 0.6rem 0.75rem; 
        }
        
        .quiz-icon { 
            width: 32px; 
            height: 32px; 
            background: var(--surface); 
            border-radius: 8px; 
            display: flex; 
            align-items: center; 
            justify-content: center; 
            color: var(--primary); 
            border: 1px solid var(--border);
        }

        .filter-btn { 
            width: 100%; 
            text-align: left; 
            padding: 0.6rem 1rem; 
            border: none; 
            background: transparent; 
            color: var(--text-primary); 
            border-radius: 30px; 
            transition: var(--transition); 
        }
        
        .filter-btn:hover { 
            background: rgba(96, 165, 250, 0.1); 
            color: var(--primary); 
            transform: translateX(4px); 
        }
        
        .filter-btn.active { 
            background: var(--gradient); 
            color: white; 
            font-weight: 500; 
        }
        
        .filter-count { 
            background: var(--border); 
            color: var(--text-secondary); 
            padding: 0.15rem 0.6rem; 
            border-radius: 30px; 
            font-size: 0.75rem; 
        }
        
        .filter-btn.active .filter-count { 
            background: rgba(255,255,255,0.2); 
            color: white; 
        }

        /* Modal */
        .modal {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.7);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 9999;
        }
        
        .modal-content {
            background: var(--surface);
            padding: 2rem;
            border-radius: var(--radius);
            max-width: 400px;
            width: 90%;
            text-align: center;
            position: relative;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.5);
            animation: slideIn 0.3s ease-out;
            border: 1px solid var(--border);
        }
        
        @keyframes slideIn {
            from { transform: translateY(-50px); opacity: 0; }
            to { transform: translateY(0); opacity: 1; }
        }
        
        .modal-icon {
            width: 70px;
            height: 70px;
            background: var(--gradient);
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            margin: 0 auto 1.5rem;
            font-size: 2rem;
            color: white;
        }
        
        .modal-btn {
            background: var(--gradient);
            color: white;
            border: none;
            padding: 0.75rem 2rem;
            border-radius: var(--radius);
            cursor: pointer;
            transition: var(--transition);
            font-weight: 600;
            font-size: 1rem;
            display: inline-flex;
            align-items: center;
            justify-content: center;
            gap: 0.5rem;
        }
        
        .modal-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(59, 130, 246, 0.4);
        }

        .no-results-mini {
            padding: 1rem;
            text-align: center;
            color: var(--text-tertiary);
            font-size: 0.8rem;
        }
        
        .no-results-mini i {
            font-size: 1.5rem;
            margin-bottom: 0.5rem;
            opacity: 0.5;
        }

        .offcanvas.offcanvas-start { 
            background-color: var(--surface); 
            color: var(--text-primary); 
            width: 280px; 
        }
        
        @keyframes slideDown {
            from { transform: translateY(-10px); opacity: 0; }
            to { transform: translateY(0); opacity: 1; }
        }
        
        @keyframes fadeOut {
            from { opacity: 1; }
            to { opacity: 0; }
        }
    </style>
</head>
<body class="dark-mode">
    <!-- Connection Status -->
    <div id="connectionStatus" class="connection-status online" style="display: none;">
        <i class="fas fa-wifi"></i>
        <span>Connected</span>
    </div>

    <!-- Offline Indicator -->
    <div id="offlineIndicator" class="offline-indicator" style="display: none;">
        <i class="fas fa-cloud" style="color: var(--warning);"></i>
        <span>Working in offline mode</span>
        <span id="cacheTimestamp" style="font-size: 0.7rem; opacity: 0.8;"></span>
    </div>

    <!-- Registration Required Modal -->
    <div id="registerModal" class="modal" style="display: flex;">
        <div class="modal-content">
            <div class="modal-icon">
                <i class="fas fa-user-lock"></i>
            </div>
            <h2>Registration Required</h2>
            <p>You need to register first to access the medical quiz platform. Create an account to unlock all features and track your progress.</p>
            <button class="modal-btn" id="goToRegisterBtn">
                <i class="fas fa-user-plus"></i> Register Now
            </button>
        </div>
    </div>

    <!-- Skeleton Loader (Shown while loading) -->
    <div id="skeletonLoader" style="display: none;">
        <div class="skeleton-container">
            <div class="skeleton-header"></div>
            <div class="skeleton-search"></div>
            <div class="skeleton-grid">
                <div class="skeleton-card"></div>
                <div class="skeleton-card"></div>
                <div class="skeleton-card"></div>
                <div class="skeleton-card"></div>
                <div class="skeleton-card"></div>
                <div class="skeleton-card"></div>
            </div>
        </div>
    </div>

    <!-- Main Content (Initially Hidden) -->
    <div id="mainApp" style="display: none;">
        <header class="app-header">
            <div class="header-container">
                <div class="header-left">
                    <button class="back-btn" id="backButton" title="Go back">
                        <i class="fas fa-arrow-left"></i>
                    </button>
                    
                    <div class="app-title" id="logoHome">
                        <div class="app-title-icon">
                            <i class="fas fa-stethoscope"></i>
                        </div>
                        <div class="app-title-text">
                            ALIF<span>Med</span>
                        </div>
                    </div>
                </div>
                
                <div class="header-right">
                    <button class="theme-toggle-header" id="themeToggleHeader" title="Toggle theme">
                        <i class="fas fa-sun"></i>
                    </button>
                    
                    <button class="profile-btn" id="profileBtn">
                        <div class="profile-avatar" id="profileAvatar">
                            <i class="fas fa-user"></i>
                        </div>
                        <div class="profile-info">
                            <div class="profile-name" id="profileName">Medical Student</div>
                            <div class="profile-role" id="profileRole"></div>
                        </div>
                    </button>
                </div>
            </div>
        </header>

        <div class="container-lg py-3 py-md-4">
            <div class="gradient-header rounded-4 p-4 p-md-5 mb-4 position-relative overflow-hidden">
                <div class="position-relative z-1 d-flex flex-wrap align-items-center justify-content-between gap-3">
                    <div>
                        <h1 class="display-6 fw-bold mb-0">Medical Quiz Dashboard</h1>
                        <p class="mb-0 opacity-75">smart Â· adaptive Â· bootstrap</p>
                    </div>
                    <div class="d-flex gap-3" id="statsDisplay"></div>
                </div>
            </div>

            <div class="d-flex d-lg-none align-items-center gap-3 mb-4">
                <button class="btn btn-outline-secondary d-flex align-items-center gap-2 py-2 px-4 rounded-pill" type="button" data-bs-toggle="offcanvas" data-bs-target="#subjectOffcanvas">
                    <i class="fas fa-sliders-h"></i> Subjects filter
                </button>
                <span class="text-secondary small" id="mobileActiveFilter">All subjects</span>
            </div>

            <div class="offcanvas offcanvas-start" tabindex="-1" id="subjectOffcanvas">
                <div class="offcanvas-header">
                    <h5 class="offcanvas-title fw-bold"><i class="fas fa-filter me-2"></i>Subjects</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="offcanvas" aria-label="Close"></button>
                </div>
                <div class="offcanvas-body">
                    <ul class="list-unstyled" id="drawerSubjectsList"></ul>
                </div>
            </div>

            <div class="row g-3 align-items-center mb-4">
                <div class="col-12">
                    <div class="search-container">
                        <div class="main-search-wrapper d-flex align-items-center">
                            <span class="search-icon-wrapper">
                                <i class="fas fa-search"></i>
                            </span>
                            <input type="text" class="main-search-input" id="smartSearch" placeholder="Search quizzes, topics, subjects..." autocomplete="off">
                            <span class="autocomplete-hint" id="autocompleteHint">
                                <i class="fas fa-lightbulb"></i>
                                <span id="hintText"></span>
                            </span>
                            <span id="globalSearchCount" class="me-2"></span>
                        </div>
                        
                        <div class="autocomplete-dropdown" id="autocompleteDropdown"></div>
                    </div>
                </div>
            </div>

            <div class="row g-4">
                <aside class="col-lg-3 d-none d-lg-block">
                    <div class="bg-surface p-4 rounded-4 border border-custom sticky-top" style="top:1rem;">
                        <h5 class="fw-bold mb-3 text-primary-custom"><i class="fas fa-filter me-2"></i>Subjects</h5>
                        <ul class="list-unstyled" id="sidebarSubjectsList"></ul>
                    </div>
                </aside>

                <main class="col-lg-9">
                    <div class="row g-4" id="subjectsGrid"></div>
                    <div class="row" id="noResultsRow" style="display: none;">
                        <div class="col-12">
                            <div class="bg-surface p-5 rounded-4 text-center border border-custom">
                                <i class="fas fa-search fs-1 text-secondary"></i>
                                <p class="mt-3 text-secondary">No matching quizzes â€” try another term</p>
                            </div>
                        </div>
                    </div>
                </main>
            </div>

            <footer class="text-center text-secondary border-top border-custom mt-5 pt-4">
                <p>ALIF Â· bootstrap medical quiz Â· offline ready</p>
            </footer>
        </div>
    </div>

    <!-- Bootstrap bundle -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>
    
    <script>
        // Firebase Configuration
        const firebaseConfig = {
            apiKey: "AIzaSyC4DSMVg4c98kQf5sSF8ueD631QgO4SXn0",
            authDomain: "medical-quiz-40228.firebaseapp.com",
            projectId: "medical-quiz-40228",
            storageBucket: "medical-quiz-40228.firebasestorage.app",
            messagingSenderId: "483043078873",
            appId: "1:483043078873:web:4029dd83e53557f08b04c8"
        };

        // Initialize Firebase
        firebase.initializeApp(firebaseConfig);
        const db = firebase.firestore();

        // Enable offline persistence
        db.enablePersistence({
            synchronizeTabs: true
        }).catch((err) => {
            if (err.code === 'failed-precondition') {
                console.log('Persistence failed: Multiple tabs open');
            } else if (err.code === 'unimplemented') {
                console.log('Persistence not supported');
            }
        });

        // Enhanced App Manager with Offline & Badge Support
        class AppManager {
            constructor() {
                this.currentUser = null;
                this.userData = null;
                this.registeredYears = [];
                this.isOnline = navigator.onLine;
                this.syncInProgress = false;
                this.cacheKey = 'quiz_data_cache';
                this.quizData = null;
                this.badgeType = null; // 'premium', 'gold', or null
            }

            async initialize() {
                // Show skeleton loader
                this.showSkeletonLoader();
                
                try {
                    // Initialize connection monitoring
                    this.initConnectionMonitoring();
                    
                    // Check if user is registered
                    const storedUser = localStorage.getItem('currentUser');
                    if (!storedUser) {
                        document.getElementById('registerModal').style.display = 'flex';
                        document.getElementById('skeletonLoader').style.display = 'none';
                        return;
                    }

                    this.currentUser = JSON.parse(storedUser);
                    
                    // Try to load from cache first
                    await this.loadFromCache();
                    
                    // Try to fetch fresh data from Firebase
                    if (this.isOnline) {
                        await this.fetchUserData();
                    } else {
                        this.showOfflineMessage();
                    }
                    
                    // Update profile with badge
                    await this.updateProfileWithBadge();
                    
                    // Load quiz data (from cache or default)
                    await this.loadQuizData();
                    
                    // Initialize the main app
                    this.initializeMainApp();
                    
                } catch (error) {
                    console.error('Initialization error:', error);
                    // If all else fails, load default quiz data
                    this.quizData = this.getDefaultQuizData();
                    this.initializeMainApp();
                } finally {
                    // Hide skeleton loader
                    document.getElementById('skeletonLoader').style.display = 'none';
                    document.getElementById('mainApp').style.display = 'block';
                }
            }

            showSkeletonLoader() {
                document.getElementById('registerModal').style.display = 'none';
                document.getElementById('mainApp').style.display = 'none';
                document.getElementById('skeletonLoader').style.display = 'block';
            }

            initConnectionMonitoring() {
                window.addEventListener('online', () => this.handleConnectionRestored());
                window.addEventListener('offline', () => this.handleConnectionLost());
                this.updateConnectionStatus(navigator.onLine);
            }

            updateConnectionStatus(isOnline) {
                this.isOnline = isOnline;
                const statusDiv = document.getElementById('connectionStatus');
                const offlineIndicator = document.getElementById('offlineIndicator');

                if (isOnline) {
                    statusDiv.className = 'connection-status online';
                    statusDiv.innerHTML = '<i class="fas fa-wifi"></i><span>Connected</span>';
                    statusDiv.style.display = 'flex';
                    offlineIndicator.style.display = 'none';
                    
                    setTimeout(() => {
                        if (this.isOnline) {
                            statusDiv.style.display = 'none';
                        }
                    }, 3000);
                } else {
                    statusDiv.className = 'connection-status offline';
                    statusDiv.innerHTML = '<i class="fas fa-wifi-slash"></i><span>Offline Mode</span>';
                    statusDiv.style.display = 'flex';
                    offlineIndicator.style.display = 'flex';
                    
                    // Show cache timestamp
                    const cache = localStorage.getItem(this.cacheKey);
                    if (cache) {
                        const data = JSON.parse(cache);
                        document.getElementById('cacheTimestamp').textContent = 
                            `Last updated: ${new Date(data.timestamp).toLocaleTimeString()}`;
                    }
                }
            }

            handleConnectionLost() {
                console.log('Connection lost - switching to offline mode');
                this.updateConnectionStatus(false);
                this.showMessage('You are offline. Using cached data.', 'warning');
            }

            async handleConnectionRestored() {
                console.log('Connection restored - syncing data');
                this.updateConnectionStatus(true);
                
                const statusDiv = document.getElementById('connectionStatus');
                statusDiv.className = 'connection-status syncing';
                statusDiv.innerHTML = '<i class="fas fa-sync-alt fa-spin"></i><span>Syncing...</span>';
                statusDiv.style.display = 'flex';
                
                this.syncInProgress = true;
                
                try {
                    await this.fetchUserData();
                    await this.updateProfileWithBadge();
                    this.showMessage('Data synced successfully!', 'success');
                } catch (error) {
                    console.error('Sync error:', error);
                } finally {
                    this.syncInProgress = false;
                    setTimeout(() => {
                        if (this.isOnline && !this.syncInProgress) {
                            statusDiv.style.display = 'none';
                        }
                    }, 2000);
                }
            }

            async loadFromCache() {
                try {
                    const cached = localStorage.getItem(this.cacheKey);
                    if (cached) {
                        const data = JSON.parse(cached);
                        this.userData = data.userData;
                        console.log('Loaded from cache:', new Date(data.timestamp).toLocaleString());
                    }
                } catch (error) {
                    console.error('Error loading from cache:', error);
                }
            }

            saveToCache() {
                try {
                    const cacheData = {
                        userData: this.userData,
                        timestamp: Date.now()
                    };
                    localStorage.setItem(this.cacheKey, JSON.stringify(cacheData));
                } catch (error) {
                    console.error('Error saving to cache:', error);
                }
            }

            async fetchUserData() {
                try {
                    const userDoc = await db.collection('users').doc(this.currentUser.id).get();
                    if (userDoc.exists) {
                        this.userData = userDoc.data();
                        
                        // Update localStorage
                        localStorage.setItem('currentUser', JSON.stringify({
                            ...this.currentUser,
                            ...this.userData
                        }));
                        
                        // Save to cache
                        this.saveToCache();
                    } else {
                        // Fallback to localStorage
                        this.userData = this.currentUser;
                    }
                } catch (error) {
                    console.error('Error fetching user data:', error);
                    // Fallback to localStorage
                    this.userData = this.currentUser;
                    
                    // Try to load from cache
                    await this.loadFromCache();
                }
            }

            async updateProfileWithBadge() {
                // Get registered years
                this.registeredYears = (this.userData?.registeredYears || [])
                    .map(y => y.toString());
                
                console.log('Registered years:', this.registeredYears);
                
                // Determine badge type
                const yearCount = this.registeredYears.length;
                
                // Check for premium from admin
                const isPremiumFromAdmin = 
                    this.userData?.status === 'premium' ||
                    this.userData?.role === 'premium' ||
                    this.userData?.plan === 'premium';

                if (isPremiumFromAdmin || yearCount === 6) {
                    this.badgeType = 'premium';
                    console.log('ðŸŽ¯ PREMIUM badge awarded');
                } else if (yearCount >= 4) {
                    this.badgeType = 'gold';
                    console.log('ðŸ¥‡ GOLD badge awarded');
                } else {
                    this.badgeType = null;
                }

                // Update UI
                const profileName = document.getElementById('profileName');
                const profileRole = document.getElementById('profileRole');
                const profileAvatar = document.getElementById('profileAvatar');
                
                // Set name
                if (this.userData?.name) {
                    profileName.textContent = this.userData.name.split(' ')[0] || 'Medical Student';
                    profileAvatar.innerHTML = this.userData.name.charAt(0).toUpperCase();
                }
                
                // Add crown for premium
                if (this.badgeType === 'premium') {
                    // Remove existing crown
                    const existingCrown = profileAvatar.querySelector('.premium-crown');
                    if (existingCrown) existingCrown.remove();
                    
                    // Add new crown
                    const crown = document.createElement('span');
                    crown.className = 'premium-crown';
                    crown.innerHTML = '<i class="fas fa-crown"></i>';
                    profileAvatar.appendChild(crown);
                    
                    // Update role text
                    profileRole.innerHTML = '<span class="gold-badge"><i class="fas fa-crown"></i> PREMIUM</span>';
                } else if (this.badgeType === 'gold') {
                    profileRole.innerHTML = '<span class="gold-badge"><i class="fas fa-star"></i> GOLD</span>';
                } else {
                    profileRole.textContent = this.userData?.role || 'Learner';
                }
            }

            getDefaultQuizData() {
                return [
                    { subject: "embryology", icon: "fas fa-egg", display: "Embryology", quizzes: [
                        { title: "Embryology Practice 1", href: "quiz.html", qCount: 30, type: "practice", difficulty: "beginner" },
                        { title: "Embryology Practice 2", href: "2.html", qCount: 25, type: "practice", difficulty: "beginner" },
                        { title: "Embryology Exam 2014", href: "equiz3.html", qCount: 50, type: "exam", difficulty: "advanced" },
                        { title: "Embryology Quizlet 1", href: "embryoquizlets1.html", qCount: 40, type: "quizlet", difficulty: "intermediate" },
                        { title: "Embryology Quizlet 2", href: "embryoquizlets2.html", qCount: 35, type: "quizlet", difficulty: "intermediate" },
                        { title: "Embryology Quizlet 3", href: "embryoquizlets3.html", qCount: 45, type: "quizlet", difficulty: "advanced" }
                    ] },
                    { subject: "anatomy", icon: "fas fa-bone", display: "Anatomy", quizzes: [
                        { title: "JU Anatomy Exam 2013", href: "anatomy2013.html", qCount: 60, type: "exam", difficulty: "advanced" },
                        { title: "JU Anatomy Exam 2014", href: "anatomy2014.html", qCount: 55, type: "exam", difficulty: "advanced" },
                        { title: "JU Anatomy Exam 2016", href: "anatomy2016.html", qCount: 40, type: "exam", difficulty: "intermediate" },
                        { title: "Anatomy Exam 2014", href: "anatquiz1.html", qCount: 50, type: "exam", difficulty: "advanced" },
                        { title: "CVS Anatomy 1", href: "anatomycvs1.html", qCount: 30, type: "practice", difficulty: "beginner" }
                    ] },
                    { subject: "physiology", icon: "fas fa-heartbeat", display: "Physiology", quizzes: [
                        { title: "Physiology NS 1", href: "physions1.html", qCount: 40, type: "quizlet", difficulty: "intermediate" },
                        { title: "Physiology NS 2", href: "physions2.html", qCount: 35, type: "quizlet", difficulty: "intermediate" },
                        { title: "Physiology Exam 2016", href: "PHYSIO2016.html", qCount: 50, type: "exam", difficulty: "advanced" }
                    ] },
                    { subject: "biochemistry", icon: "fas fa-flask", display: "Biochemistry", quizzes: [
                        { title: "Biochemistry Enzymes 1", href: "biochemEN1.html", qCount: 30, type: "practice", difficulty: "beginner" },
                        { title: "Biochemistry Enzymes 2", href: "biochemEN2.html", qCount: 28, type: "practice", difficulty: "beginner" },
                        { title: "Nucleic Acids 1", href: "biochemNA1.html", qCount: 35, type: "quizlet", difficulty: "intermediate" },
                        { title: "Proteins 1", href: "biochemprotein1.html", qCount: 35, type: "quizlet", difficulty: "beginner" }
                    ] },
                    { subject: "histopathology", icon: "fas fa-microscope", display: "Histopathology", quizzes: [
                        { title: "Histopathology Quiz 1", href: "histoquiz1.html", qCount: 25, type: "practice", difficulty: "intermediate" }
                    ] },
                    { subject: "renal", icon: "fas fa-tint", display: "Renal", quizzes: [
                        { title: "Renal Physiology Quiz", href: "renal.html", qCount: 30, type: "practice", difficulty: "intermediate" }
                    ] }
                ];
            }

            async loadQuizData() {
                // For now, use default data
                // In a real app, you'd fetch this from Firebase or an API
                this.quizData = this.getDefaultQuizData();
                
                // Try to load from cache if available
                try {
                    const cached = localStorage.getItem('quiz_data');
                    if (cached) {
                        this.quizData = JSON.parse(cached);
                    } else {
                        // Save to cache for offline use
                        localStorage.setItem('quiz_data', JSON.stringify(this.quizData));
                    }
                } catch (error) {
                    console.error('Error loading quiz data:', error);
                }
            }

            showMessage(message, type = 'info') {
                // Create toast notification
                const toast = document.createElement('div');
                toast.style.cssText = `
                    position: fixed;
                    top: 80px;
                    right: 20px;
                    background: ${type === 'success' ? '#22c55e' : type === 'warning' ? '#eab308' : '#ef4444'};
                    color: white;
                    padding: 1rem 1.5rem;
                    border-radius: 12px;
                    font-size: 0.9rem;
                    z-index: 10000;
                    box-shadow: 0 4px 15px rgba(0,0,0,0.3);
                    animation: slideIn 0.3s ease-out;
                `;
                toast.innerHTML = `<i class="fas fa-${type === 'success' ? 'check-circle' : 'exclamation-circle'} me-2"></i>${message}`;
                document.body.appendChild(toast);
                
                setTimeout(() => {
                    toast.style.animation = 'fadeOut 0.3s ease-out';
                    setTimeout(() => toast.remove(), 300);
                }, 3000);
            }

            showOfflineMessage() {
                this.showMessage('You are in offline mode. Some features may be limited.', 'warning');
            }

            initializeMainApp() {
                const quizData = this.quizData;
                
                // Calculate stats
                const totalQuizzes = quizData.reduce((acc, s) => acc + s.quizzes.length, 0);
                const totalQuestions = quizData.reduce((acc, s) => acc + s.quizzes.reduce((qacc, q) => qacc + q.qCount, 0), 0);
                
                document.getElementById('statsDisplay').innerHTML = `
                    <div class="stat-card"><div class="stat-value">${totalQuizzes}</div><div class="small">Quizzes</div></div>
                    <div class="stat-card"><div class="stat-value">${totalQuestions}+</div><div class="small">Questions</div></div>
                    <div class="stat-card"><div class="stat-value">${quizData.length}</div><div class="small">Subjects</div></div>
                `;

                let currentFilter = 'all';
                let currentSearch = '';
                let selectedSuggestionIndex = -1;
                
                const miniSearchStates = {};
                const miniFilterStates = {};
                const miniSortStates = {};
                const miniSelectedSuggestionIndices = {};

                quizData.forEach(subject => {
                    miniSearchStates[subject.subject] = '';
                    miniFilterStates[subject.subject] = 'all';
                    miniSortStates[subject.subject] = 'default';
                    miniSelectedSuggestionIndices[subject.subject] = -1;
                });

                // Back button
                document.getElementById('backButton').addEventListener('click', () => {
                    if (window.history.length > 1) {
                        window.history.back();
                    } else {
                        window.scrollTo({ top: 0, behavior: 'smooth' });
                        
                        const toast = document.createElement('div');
                        toast.style.cssText = `
                            position: fixed;
                            top: 80px;
                            left: 50%;
                            transform: translateX(-50%);
                            background: var(--gradient);
                            color: white;
                            padding: 0.5rem 1.5rem;
                            border-radius: 30px;
                            font-size: 0.9rem;
                            z-index: 9999;
                            box-shadow: 0 4px 15px rgba(0,0,0,0.3);
                            animation: slideDown 0.3s ease-out;
                        `;
                        toast.innerHTML = '<i class="fas fa-arrow-up me-2"></i>Scrolled to top';
                        document.body.appendChild(toast);
                        
                        setTimeout(() => {
                            toast.style.animation = 'fadeOut 0.3s ease-out';
                            setTimeout(() => toast.remove(), 300);
                        }, 2000);
                    }
                });

                // Profile button
                document.getElementById('profileBtn').addEventListener('click', () => {
                    window.location.href = 'profile.html';
                });

                // Theme toggle
                const themeToggleHeader = document.getElementById('themeToggleHeader');
                const body = document.body;
                const icon = themeToggleHeader.querySelector('i');
                
                if (localStorage.getItem('theme') === 'dark') {
                    body.classList.replace('light-mode','dark-mode'); 
                    icon.className = 'fas fa-sun'; 
                } else if (localStorage.getItem('theme') === 'light') {
                    body.classList.replace('dark-mode','light-mode'); 
                    icon.className = 'fas fa-moon'; 
                }

                themeToggleHeader.addEventListener('click', () => {
                    if (body.classList.contains('light-mode')) {
                        body.classList.replace('light-mode','dark-mode'); 
                        icon.className = 'fas fa-sun'; 
                        localStorage.setItem('theme','dark');
                    } else {
                        body.classList.replace('dark-mode','light-mode'); 
                        icon.className = 'fas fa-moon'; 
                        localStorage.setItem('theme','light');
                    }
                });

                // Filter functions
                function setFilter(filter) {
                    currentFilter = filter;
                    renderAllFilters();
                    renderCards();
                    const subj = quizData.find(s => s.subject === filter);
                    document.getElementById('mobileActiveFilter').innerText = !filter || filter==='all' ? 'All subjects' : (subj?.display || filter);
                    const offcanvasEl = document.getElementById('subjectOffcanvas');
                    const bsOffcanvas = bootstrap.Offcanvas.getInstance(offcanvasEl);
                    if (bsOffcanvas) bsOffcanvas.hide();
                }

                function renderAllFilters() {
                    const allCount = quizData.reduce((acc, s) => acc + s.quizzes.length, 0);
                    let html = `<li class="mb-2"><button class="filter-btn d-flex align-items-center ${currentFilter==='all'?'active':''}" data-filter="all"><i class="fas fa-th me-2"></i> All subjects <span class="filter-count ms-auto">${allCount}</span></button></li>`;
                    quizData.forEach(s => {
                        html += `<li class="mb-2"><button class="filter-btn d-flex align-items-center ${currentFilter===s.subject?'active':''}" data-filter="${s.subject}"><i class="${s.icon} me-2"></i> ${s.display} <span class="filter-count ms-auto">${s.quizzes.length}</span></button></li>`;
                    });
                    document.getElementById('sidebarSubjectsList').innerHTML = html;
                    document.querySelectorAll('#sidebarSubjectsList .filter-btn').forEach(btn => {
                        btn.addEventListener('click', () => setFilter(btn.dataset.filter));
                    });

                    let drawerHtml = `<li class="mb-2"><button class="filter-btn d-flex align-items-center ${currentFilter==='all'?'active':''}" data-filter="all"><i class="fas fa-th me-2"></i> All subjects <span class="filter-count ms-auto">${allCount}</span></button></li>`;
                    quizData.forEach(s => {
                        drawerHtml += `<li class="mb-2"><button class="filter-btn d-flex align-items-center ${currentFilter===s.subject?'active':''}" data-filter="${s.subject}"><i class="${s.icon} me-2"></i> ${s.display} <span class="filter-count ms-auto">${s.quizzes.length}</span></button></li>`;
                    });
                    document.getElementById('drawerSubjectsList').innerHTML = drawerHtml;
                    document.querySelectorAll('#drawerSubjectsList .filter-btn').forEach(btn => {
                        btn.addEventListener('click', () => setFilter(btn.dataset.filter));
                    });
                }

                function highlightText(text, term) {
                    if (!term) return text;
                    const regex = new RegExp(`(${term.replace(/[.*+?^${}()|[\]\\]/g,'\\$&')})`, 'gi');
                    return text.replace(regex, '<span class="autocomplete-match">$1</span>');
                }

                function sortQuizzes(quizzes, sortType) {
                    const sorted = [...quizzes];
                    switch(sortType) {
                        case 'title-asc': return sorted.sort((a, b) => a.title.localeCompare(b.title));
                        case 'title-desc': return sorted.sort((a, b) => b.title.localeCompare(a.title));
                        case 'qcount-asc': return sorted.sort((a, b) => a.qCount - b.qCount);
                        case 'qcount-desc': return sorted.sort((a, b) => b.qCount - a.qCount);
                        default: return sorted;
                    }
                }

                function filterByType(quizzes, filterType) {
                    if (filterType === 'all') return quizzes;
                    return quizzes.filter(q => q.type === filterType);
                }

                function updateGlobalSearchCount() {
                    const globalCountEl = document.getElementById('globalSearchCount');
                    if (currentSearch) {
                        let totalMatches = 0;
                        quizData.forEach(subject => {
                            if (currentFilter === 'all' || subject.subject === currentFilter) {
                                const matches = subject.quizzes.filter(q => 
                                    q.title.toLowerCase().includes(currentSearch.toLowerCase())
                                ).length;
                                totalMatches += matches;
                            }
                        });
                        globalCountEl.innerHTML = `<span class="global-search-count">${totalMatches} matches</span>`;
                    } else {
                        globalCountEl.innerHTML = '';
                    }
                }

                function getMiniAutocompleteSuggestions(query, subjectData) {
                    if (!query || query.length < 1) return [];
                    
                    const lowercaseQuery = query.toLowerCase();
                    const suggestions = [];
                    
                    subjectData.quizzes.forEach(quiz => {
                        if (quiz.title.toLowerCase().includes(lowercaseQuery)) {
                            suggestions.push({
                                type: 'quiz',
                                title: quiz.title,
                                subtitle: `${quiz.qCount} questions`,
                                icon: subjectData.icon,
                                badge: quiz.type,
                                href: quiz.href
                            });
                        }
                    });
                    
                    ['practice', 'exam', 'quizlet'].forEach(type => {
                        if (type.includes(lowercaseQuery)) {
                            const count = subjectData.quizzes.filter(q => q.type === type).length;
                            if (count > 0) {
                                suggestions.push({
                                    type: 'filter',
                                    title: type.charAt(0).toUpperCase() + type.slice(1),
                                    subtitle: `${count} quizzes`,
                                    icon: type === 'practice' ? 'fas fa-play-circle' : 
                                          type === 'exam' ? 'fas fa-file-alt' : 'fas fa-code',
                                    filter: type
                                });
                            }
                        }
                    });
                    
                    const unique = suggestions.filter((v, i, a) => 
                        a.findIndex(t => t.title === v.title) === i
                    ).slice(0, 5);
                    
                    return unique;
                }

                function renderMiniAutocompleteDropdown(subject, suggestions, query, dropdownId, hintId) {
                    const dropdown = document.getElementById(dropdownId);
                    const hint = document.getElementById(hintId);
                    
                    if (!suggestions || suggestions.length === 0) {
                        if (dropdown) dropdown.classList.remove('show');
                        if (hint) hint.classList.remove('show');
                        return;
                    }
                    
                    if (suggestions.length > 0 && hint) {
                        hint.querySelector('span').textContent = suggestions[0].title;
                        hint.classList.add('show');
                    }
                    
                    let html = '';
                    suggestions.forEach((suggestion, index) => {
                        const isSelected = index === miniSelectedSuggestionIndices[subject];
                        const selectedClass = isSelected ? 'selected' : '';
                        
                        if (suggestion.type === 'quiz') {
                            html += `
                                <div class="mini-autocomplete-item ${selectedClass}" data-type="quiz" data-href="${suggestion.href}">
                                    <div class="mini-autocomplete-icon"><i class="${suggestion.icon}"></i></div>
                                    <div class="mini-autocomplete-content">
                                        <div class="mini-autocomplete-title">${highlightText(suggestion.title, query)}</div>
                                        <div class="mini-autocomplete-subtitle">${suggestion.subtitle}</div>
                                    </div>
                                    <span class="mini-autocomplete-badge ${suggestion.badge}">${suggestion.badge}</span>
                                </div>
                            `;
                        } else if (suggestion.type === 'filter') {
                            html += `
                                <div class="mini-autocomplete-item ${selectedClass}" data-type="filter" data-filter="${suggestion.filter}" data-subject="${subject}">
                                    <div class="mini-autocomplete-icon"><i class="${suggestion.icon}"></i></div>
                                    <div class="mini-autocomplete-content">
                                        <div class="mini-autocomplete-title">${highlightText(suggestion.title, query)}</div>
                                        <div class="mini-autocomplete-subtitle">${suggestion.subtitle}</div>
                                    </div>
                                    <span class="mini-autocomplete-category">Filter</span>
                                </div>
                            `;
                        }
                    });
                    
                    dropdown.innerHTML = html;
                    dropdown.classList.add('show');
                    
                    document.querySelectorAll(`#${dropdownId} .mini-autocomplete-item`).forEach(item => {
                        item.addEventListener('click', () => {
                            const type = item.dataset.type;
                            const subject = item.dataset.subject;
                            
                            if (type === 'quiz') {
                                window.location.href = item.dataset.href;
                            } else if (type === 'filter') {
                                miniFilterStates[subject] = item.dataset.filter;
                                const input = document.querySelector(`.mini-search-input[data-subject="${subject}"]`);
                                if (input) {
                                    input.value = '';
                                    miniSearchStates[subject] = '';
                                }
                                updateSubjectQuizzes(subject, '');
                            }
                            
                            dropdown.classList.remove('show');
                            if (hint) hint.classList.remove('show');
                        });
                    });
                }

                function getAutocompleteSuggestions(query) {
                    if (!query || query.length < 2) return [];
                    
                    const lowercaseQuery = query.toLowerCase();
                    const suggestions = [];
                    
                    quizData.forEach(subject => {
                        subject.quizzes.forEach(quiz => {
                            if (quiz.title.toLowerCase().includes(lowercaseQuery)) {
                                suggestions.push({
                                    type: 'quiz',
                                    title: quiz.title,
                                    subtitle: `${subject.display} â€¢ ${quiz.qCount} questions`,
                                    icon: subject.icon,
                                    badge: quiz.type,
                                    subject: subject.subject,
                                    href: quiz.href
                                });
                            }
                        });
                    });
                    
                    quizData.forEach(subject => {
                        if (subject.display.toLowerCase().includes(lowercaseQuery)) {
                            suggestions.push({
                                type: 'subject',
                                title: subject.display,
                                subtitle: `${subject.quizzes.length} quizzes available`,
                                icon: subject.icon,
                                subject: subject.subject
                            });
                        }
                    });
                    
                    const unique = suggestions.filter((v, i, a) => 
                        a.findIndex(t => t.title === v.title) === i
                    ).slice(0, 8);
                    
                    return unique;
                }

                function renderAutocompleteDropdown(suggestions, query) {
                    const dropdown = document.getElementById('autocompleteDropdown');
                    const hint = document.getElementById('autocompleteHint');
                    const hintText = document.getElementById('hintText');
                    
                    if (!suggestions || suggestions.length === 0) {
                        dropdown.classList.remove('show');
                        hint.classList.remove('show');
                        return;
                    }
                    
                    if (suggestions.length > 0) {
                        hintText.textContent = suggestions[0].title;
                        hint.classList.add('show');
                    }
                    
                    let html = '';
                    suggestions.forEach((suggestion, index) => {
                        const isSelected = index === selectedSuggestionIndex;
                        const selectedClass = isSelected ? 'selected' : '';
                        
                        if (suggestion.type === 'quiz') {
                            html += `
                                <div class="autocomplete-item ${selectedClass}" data-type="quiz" data-href="${suggestion.href}">
                                    <div class="autocomplete-icon"><i class="${suggestion.icon}"></i></div>
                                    <div class="autocomplete-content">
                                        <div class="autocomplete-title">${highlightText(suggestion.title, query)}</div>
                                        <div class="autocomplete-subtitle">
                                            <span>${suggestion.subtitle}</span>
                                            <span class="autocomplete-badge ${suggestion.badge}">${suggestion.badge}</span>
                                        </div>
                                    </div>
                                </div>
                            `;
                        } else if (suggestion.type === 'subject') {
                            html += `
                                <div class="autocomplete-item ${selectedClass}" data-type="subject" data-subject="${suggestion.subject}">
                                    <div class="autocomplete-icon"><i class="${suggestion.icon}"></i></div>
                                    <div class="autocomplete-content">
                                        <div class="autocomplete-title">${highlightText(suggestion.title, query)}</div>
                                        <div class="autocomplete-subtitle">${suggestion.subtitle}</div>
                                    </div>
                                    <span class="autocomplete-category">Subject</span>
                                </div>
                            `;
                        }
                    });
                    
                    dropdown.innerHTML = html;
                    dropdown.classList.add('show');
                    
                    document.querySelectorAll('.autocomplete-item').forEach(item => {
                        item.addEventListener('click', () => {
                            const type = item.dataset.type;
                            
                            if (type === 'quiz') {
                                window.location.href = item.dataset.href;
                            } else if (type === 'subject') {
                                setFilter(item.dataset.subject);
                                document.getElementById('smartSearch').value = '';
                                currentSearch = '';
                                renderCards();
                            }
                            
                            dropdown.classList.remove('show');
                            hint.classList.remove('show');
                        });
                    });
                }

                function updateSubjectQuizzes(subjectKey, searchTerm) {
                    const subject = quizData.find(s => s.subject === subjectKey);
                    if (!subject) return;
                    
                    const cards = document.querySelectorAll('.subject-card');
                    let targetCard = null;
                    
                    for (let card of cards) {
                        const header = card.querySelector('h3');
                        if (header && header.textContent === subject.display) {
                            targetCard = card;
                            break;
                        }
                    }
                    
                    if (!targetCard) return;
                    
                    const miniTerm = searchTerm.toLowerCase();
                    const filterType = miniFilterStates[subjectKey] || 'all';
                    const sortType = miniSortStates[subjectKey] || 'default';
                    
                    let filtered = subject.quizzes;
                    
                    if (miniTerm) {
                        filtered = filtered.filter(q => q.title.toLowerCase().includes(miniTerm));
                    }
                    
                    filtered = filterByType(filtered, filterType);
                    filtered = sortQuizzes(filtered, sortType);
                    
                    const badge = targetCard.querySelector('.badge.bg-primary');
                    if (badge) {
                        badge.textContent = `${filtered.length}/${subject.quizzes.length}`;
                    }
                    
                    const quizList = targetCard.querySelector('.quiz-list');
                    if (!quizList) return;
                    
                    const itemsHtml = filtered.map(q => {
                        const titleDisplay = miniTerm ? highlightText(q.title, miniTerm) : q.title;
                        
                        let badgeClass = 'bg-secondary';
                        if (q.type === 'exam') badgeClass = 'badge-exam';
                        else if (q.type === 'practice') badgeClass = 'badge-practice';
                        else if (q.type === 'quizlet') badgeClass = 'badge-quizlet';
                        
                        return `<li class="quiz-item">
                            <a href="${q.href}" class="quiz-link">
                                <span class="d-flex align-items-center gap-2">
                                    <span class="quiz-icon"><i class="fas ${q.type==='exam'?'fa-file-alt':(q.type==='practice'?'fa-play-circle':'fa-code')}"></i></span>
                                    <span class="quiz-title">${titleDisplay}</span>
                                </span>
                                <span class="d-flex align-items-center gap-2">
                                    <span class="badge ${badgeClass} rounded-pill">${q.qCount}</span>
                                    <i class="fas fa-arrow-right text-secondary"></i>
                                </span>
                            </a>
                        </li>`;
                    }).join('');
                    
                    const noResultsHtml = filtered.length === 0 ? `
                        <div class="no-results-mini">
                            <i class="fas fa-search"></i>
                            <p>No matching quizzes</p>
                        </div>
                    ` : '';
                    
                    quizList.innerHTML = itemsHtml || noResultsHtml;
                    
                    const existingStats = targetCard.querySelector('.search-stats');
                    if (miniTerm) {
                        if (existingStats) {
                            const span = existingStats.querySelector('span:first-child');
                            if (span) span.innerHTML = `<i class="fas fa-search"></i> ${filtered.length} results`;
                        } else {
                            const statsDiv = document.createElement('div');
                            statsDiv.className = 'search-stats';
                            statsDiv.innerHTML = `
                                <span><i class="fas fa-search"></i> ${filtered.length} results</span>
                                <span class="clear-search" data-subject="${subjectKey}">Clear âœ•</span>
                            `;
                            
                            const sortDiv = targetCard.querySelector('.mini-sort');
                            if (sortDiv) {
                                sortDiv.insertAdjacentElement('afterend', statsDiv);
                            }
                            
                            statsDiv.querySelector('.clear-search').addEventListener('click', () => {
                                miniSearchStates[subjectKey] = '';
                                const input = document.querySelector(`.mini-search-input[data-subject="${subjectKey}"]`);
                                if (input) {
                                    input.value = '';
                                }
                                
                                const dropdown = document.getElementById(`miniDropdown-${subjectKey}`);
                                const hint = document.getElementById(`miniHint-${subjectKey}`);
                                if (dropdown) dropdown.classList.remove('show');
                                if (hint) hint.classList.remove('show');
                                
                                updateSubjectQuizzes(subjectKey, '');
                            });
                        }
                    } else if (existingStats) {
                        existingStats.remove();
                    }
                }

                function renderCards() {
                    const term = currentSearch.trim().toLowerCase();
                    let anyVisible = false;
                    let cardsHtml = '';

                    quizData.forEach(subject => {
                        if (currentFilter !== 'all' && subject.subject !== currentFilter) return;
                        
                        let filtered = subject.quizzes;
                        if (term) {
                            filtered = filtered.filter(q => q.title.toLowerCase().includes(term));
                        }
                        
                        const miniTerm = miniSearchStates[subject.subject]?.toLowerCase() || '';
                        if (miniTerm) {
                            filtered = filtered.filter(q => q.title.toLowerCase().includes(miniTerm));
                        }
                        
                        filtered = filterByType(filtered, miniFilterStates[subject.subject] || 'all');
                        filtered = sortQuizzes(filtered, miniSortStates[subject.subject] || 'default');
                        
                        if (filtered.length === 0 && term === '' && miniTerm === '') return;
                        if (filtered.length === 0 && term !== '') return;
                        anyVisible = true;

                        const itemsHtml = filtered.map(q => {
                            const highlightTerm = miniTerm || term;
                            const titleDisplay = highlightTerm ? highlightText(q.title, highlightTerm) : q.title;
                            
                            let badgeClass = 'bg-secondary';
                            if (q.type === 'exam') badgeClass = 'badge-exam';
                            else if (q.type === 'practice') badgeClass = 'badge-practice';
                            else if (q.type === 'quizlet') badgeClass = 'badge-quizlet';
                            
                            return `<li class="quiz-item">
                                <a href="${q.href}" class="quiz-link">
                                    <span class="d-flex align-items-center gap-2">
                                        <span class="quiz-icon"><i class="fas ${q.type==='exam'?'fa-file-alt':(q.type==='practice'?'fa-play-circle':'fa-code')}"></i></span>
                                        <span class="quiz-title">${titleDisplay}</span>
                                    </span>
                                    <span class="d-flex align-items-center gap-2">
                                        <span class="badge ${badgeClass} rounded-pill">${q.qCount}</span>
                                        <i class="fas fa-arrow-right text-secondary"></i>
                                    </span>
                                </a>
                            </li>`;
                        }).join('');

                        const noResultsHtml = filtered.length === 0 ? `
                            <div class="no-results-mini">
                                <i class="fas fa-search"></i>
                                <p>No matching quizzes</p>
                            </div>
                        ` : '';

                        const tooMany = subject.quizzes.length > 6;
                        const dropdownId = `miniDropdown-${subject.subject}`;
                        const hintId = `miniHint-${subject.subject}`;
                        
                        cardsHtml += `<div class="col-md-6 col-xl-4">
                            <div class="subject-card rounded-4 p-0">
                                <div class="p-3 d-flex align-items-center gap-3 border-bottom border-custom" style="background:linear-gradient(135deg, rgba(96,165,250,0.05), rgba(59,130,246,0.05));">
                                    <div class="bg-primary bg-opacity-10 p-3 rounded-3"><i class="${subject.icon} fs-3 text-primary-custom"></i></div>
                                    <div><h3 class="h5 mb-0">${subject.display}</h3><span class="small text-secondary">${subject.quizzes.length} quizzes</span></div>
                                    <span class="badge bg-primary rounded-pill ms-auto">${filtered.length}/${subject.quizzes.length}</span>
                                </div>
                                
                                <div class="mini-search-container">
                                    <div class="mini-search-wrapper">
                                        <input type="text" class="mini-search-input" 
                                            placeholder="Search in ${subject.display}..." 
                                            data-subject="${subject.subject}"
                                            value="${miniSearchStates[subject.subject] || ''}"
                                            autocomplete="off">
                                        <span class="mini-autocomplete-hint" id="${hintId}">
                                            <i class="fas fa-lightbulb"></i>
                                            <span></span>
                                        </span>
                                    </div>
                                    
                                    <div class="mini-autocomplete-dropdown" id="${dropdownId}"></div>
                                </div>
                                
                                <div class="mini-filters">
                                    <button class="mini-filter-btn ${miniFilterStates[subject.subject] === 'all' ? 'active' : ''}" data-subject="${subject.subject}" data-filter="all">
                                        <i class="fas fa-list"></i> All
                                    </button>
                                    <button class="mini-filter-btn ${miniFilterStates[subject.subject] === 'practice' ? 'active' : ''}" data-subject="${subject.subject}" data-filter="practice">
                                        <i class="fas fa-play-circle"></i> Practice
                                    </button>
                                    <button class="mini-filter-btn ${miniFilterStates[subject.subject] === 'exam' ? 'active' : ''}" data-subject="${subject.subject}" data-filter="exam">
                                        <i class="fas fa-file-alt"></i> Exam
                                    </button>
                                    <button class="mini-filter-btn ${miniFilterStates[subject.subject] === 'quizlet' ? 'active' : ''}" data-subject="${subject.subject}" data-filter="quizlet">
                                        <i class="fas fa-code"></i> Quizlet
                                    </button>
                                </div>
                                
                                <div class="mini-sort">
                                    <select class="mini-sort-select" data-subject="${subject.subject}">
                                        <option value="default" ${miniSortStates[subject.subject] === 'default' ? 'selected' : ''}>ðŸ“Š Default order</option>
                                        <option value="title-asc" ${miniSortStates[subject.subject] === 'title-asc' ? 'selected' : ''}>ðŸ“ Title A-Z</option>
                                        <option value="title-desc" ${miniSortStates[subject.subject] === 'title-desc' ? 'selected' : ''}>ðŸ“ Title Z-A</option>
                                        <option value="qcount-asc" ${miniSortStates[subject.subject] === 'qcount-asc' ? 'selected' : ''}>ðŸ”¢ Questions (low to high)</option>
                                        <option value="qcount-desc" ${miniSortStates[subject.subject] === 'qcount-desc' ? 'selected' : ''}>ðŸ”¢ Questions (high to low)</option>
                                    </select>
                                </div>
                                
                                <div class="p-3">
                                    <ul class="list-unstyled quiz-list ${tooMany?'collapsed':''}">
                                        ${itemsHtml || noResultsHtml}
                                    </ul>
                                </div>
                                
                                ${tooMany ? `<button class="view-all-btn btn btn-link w-100 text-decoration-none border-top border-custom py-2" style="color:var(--primary);"><span>View all quizzes</span> <i class="fas fa-chevron-down"></i></button>` : ''}
                            </div>
                        </div>`;
                    });

                    document.getElementById('subjectsGrid').innerHTML = cardsHtml;
                    document.getElementById('noResultsRow').style.display = anyVisible ? 'none' : 'flex';
                    
                    updateGlobalSearchCount();
                    
                    // Mini search event listeners
                    document.querySelectorAll('.mini-search-input').forEach(input => {
                        const subject = input.dataset.subject;
                        const dropdownId = `miniDropdown-${subject}`;
                        const hintId = `miniHint-${subject}`;
                        const dropdown = document.getElementById(dropdownId);
                        
                        let timeout;
                        let suggestionTimeout;
                        let hideDropdownTimeout;
                        
                        input.addEventListener('input', (e) => {
                            const query = e.target.value;
                            
                            miniSelectedSuggestionIndices[subject] = -1;
                            
                            clearTimeout(suggestionTimeout);
                            clearTimeout(hideDropdownTimeout);
                            
                            if (query.length === 0) {
                                hideDropdownTimeout = setTimeout(() => {
                                    if (dropdown) dropdown.classList.remove('show');
                                    const hint = document.getElementById(hintId);
                                    if (hint) hint.classList.remove('show');
                                }, 200);
                                return;
                            }
                            
                            suggestionTimeout = setTimeout(() => {
                                const subjectData = quizData.find(s => s.subject === subject);
                                const suggestions = getMiniAutocompleteSuggestions(query, subjectData);
                                renderMiniAutocompleteDropdown(subject, suggestions, query, dropdownId, hintId);
                            }, 100);
                            
                            clearTimeout(timeout);
                            timeout = setTimeout(() => {
                                miniSearchStates[subject] = query;
                                updateSubjectQuizzes(subject, query);
                            }, 400);
                        });

                        input.addEventListener('focus', (e) => {
                            const query = e.target.value;
                            if (query.length > 0) {
                                clearTimeout(hideDropdownTimeout);
                                const subjectData = quizData.find(s => s.subject === subject);
                                const suggestions = getMiniAutocompleteSuggestions(query, subjectData);
                                renderMiniAutocompleteDropdown(subject, suggestions, query, dropdownId, hintId);
                            }
                        });

                        input.addEventListener('blur', (e) => {
                            hideDropdownTimeout = setTimeout(() => {
                                const dropdown = document.getElementById(dropdownId);
                                if (dropdown && !dropdown.matches(':hover')) {
                                    dropdown.classList.remove('show');
                                    const hint = document.getElementById(hintId);
                                    if (hint) hint.classList.remove('show');
                                }
                            }, 300);
                        });

                        if (dropdown) {
                            dropdown.addEventListener('mousedown', (e) => {
                                e.preventDefault();
                            });
                        }
                    });
                    
                    // Mini filter event listeners
                    document.querySelectorAll('.mini-filter-btn').forEach(btn => {
                        btn.addEventListener('click', (e) => {
                            const subject = e.target.dataset.subject;
                            const filter = e.target.dataset.filter;
                            miniFilterStates[subject] = filter;
                            
                            const searchTerm = miniSearchStates[subject] || '';
                            updateSubjectQuizzes(subject, searchTerm);
                        });
                    });
                    
                    // Mini sort event listeners
                    document.querySelectorAll('.mini-sort-select').forEach(select => {
                        select.addEventListener('change', (e) => {
                            const subject = e.target.dataset.subject;
                            miniSortStates[subject] = e.target.value;
                            
                            const searchTerm = miniSearchStates[subject] || '';
                            updateSubjectQuizzes(subject, searchTerm);
                        });
                    });

                    // Expand/collapse
                    document.querySelectorAll('.view-all-btn').forEach(btn => {
                        const card = btn.closest('.subject-card');
                        const list = card.querySelector('.quiz-list');
                        
                        btn.replaceWith(btn.cloneNode(true));
                        const newBtn = card.querySelector('.view-all-btn');
                        
                        newBtn.addEventListener('click', (e) => {
                            e.preventDefault();
                            const expanded = list.classList.toggle('expanded');
                            newBtn.querySelector('span').innerText = expanded ? 'Show less' : 'View all quizzes';
                            newBtn.querySelector('i').classList.toggle('fa-chevron-down', !expanded);
                            newBtn.querySelector('i').classList.toggle('fa-chevron-up', expanded);
                        });
                    });
                }

                // Global search
                const searchInput = document.getElementById('smartSearch');
                const dropdown = document.getElementById('autocompleteDropdown');
                const hint = document.getElementById('autocompleteHint');
                
                let timeout;
                searchInput.addEventListener('input', () => {
                    clearTimeout(timeout);
                    const query = searchInput.value;
                    
                    selectedSuggestionIndex = -1;
                    
                    const suggestions = getAutocompleteSuggestions(query);
                    renderAutocompleteDropdown(suggestions, query);
                    
                    timeout = setTimeout(() => {
                        currentSearch = query;
                        renderCards();
                    }, 150);
                });

                searchInput.addEventListener('keydown', (e) => {
                    const items = document.querySelectorAll('.autocomplete-item');
                    
                    if (items.length === 0) return;
                    
                    if (e.key === 'ArrowDown') {
                        e.preventDefault();
                        selectedSuggestionIndex = (selectedSuggestionIndex + 1) % items.length;
                        updateSelectedSuggestion();
                    } else if (e.key === 'ArrowUp') {
                        e.preventDefault();
                        selectedSuggestionIndex = selectedSuggestionIndex <= 0 ? items.length - 1 : selectedSuggestionIndex - 1;
                        updateSelectedSuggestion();
                    } else if (e.key === 'Enter' && selectedSuggestionIndex >= 0) {
                        e.preventDefault();
                        items[selectedSuggestionIndex].click();
                    } else if (e.key === 'Escape') {
                        dropdown.classList.remove('show');
                        hint.classList.remove('show');
                    }
                });

                function updateSelectedSuggestion() {
                    const items = document.querySelectorAll('.autocomplete-item');
                    items.forEach((item, index) => {
                        if (index === selectedSuggestionIndex) {
                            item.classList.add('selected');
                            const title = item.querySelector('.autocomplete-title').innerText.replace(/<[^>]*>/g, '');
                            document.getElementById('hintText').textContent = title;
                        } else {
                            item.classList.remove('selected');
                        }
                    });
                }

                document.addEventListener('click', (e) => {
                    if (!searchInput.contains(e.target) && !dropdown.contains(e.target)) {
                        dropdown.classList.remove('show');
                        hint.classList.remove('show');
                    }
                });

                document.getElementById('logoHome').addEventListener('click', () => window.scrollTo({ top:0, behavior:'smooth' }));

                renderAllFilters();
                renderCards();
                setFilter('all');
            }
        }

        // Initialize the app
        const appManager = new AppManager();

        // Handle registration modal
        document.getElementById('goToRegisterBtn').addEventListener('click', () => {
            window.location.href = 'register.html';
        });

        // Start the app
        appManager.initialize();
    </script>
</body>
</html>
