<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <title>Notifications - ALIF Medical Quiz Platform</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800;900&display=swap" rel="stylesheet">
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-firestore-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-auth-compat.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/marked@4.0.0/marked.min.js"></script>
    <!-- Add this at the end of <head> section -->
    <script src="auth-check.js"></script>
    <style>
        :root {
            --primary: #3b82f6;
            --primary-dark: #2563eb;
            --primary-light: #93c5fd;
            --secondary: #64748b;
            --success: #10b981;
            --error: #ef4444;
            --warning: #f59e0b;
            --info: #0ea5e9;
            --purple: #8b5cf6;
            --pink: #ec4899;
            --shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06);
            --radius: 16px;
            --transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            --gradient: linear-gradient(135deg, #3b82f6 0%, #60a5fa 100%);
            --trial-gradient: linear-gradient(135deg, #10b981 0%, #059669 100%);
            --trial-color: #10b981;
            --trial-dark: #059669;
        }
        body.light-mode {
            --background: #f9fafb;
            --surface: #ffffff;
            --text-primary: #111827;
            --text-secondary: #4b5563;
            --text-tertiary: #9ca3af;
            --border: #e5e7eb;
        }
        body.dark-mode {
            --background: #0f172a;
            --surface: #1e293b;
            --text-primary: #f9fafb;
            --text-secondary: #d1d5db;
            --text-tertiary: #6b7280;
            --border: #334155;
        }
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            -webkit-user-select: none;
            -moz-user-select: none;
            -ms-user-select: none;
            user-select: none;
            -webkit-touch-callout: none;
            touch-action: manipulation;
        }
        body {
            font-family: 'Inter', system-ui, -apple-system, sans-serif;
            background-color: var(--background);
            color: var(--text-primary);
            line-height: 1.6;
            font-size: 16px;
            transition: var(--transition);
            min-height: 100vh;
            overflow-x: hidden;
            -webkit-text-size-adjust: 100%;
            -ms-text-size-adjust: 100%;
            touch-action: pan-x pan-y;
        }
        html {
            touch-action: none;
        }
        .header {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            z-index: 1000;
            background: var(--surface);
            border-bottom: 1px solid var(--border);
            box-shadow: var(--shadow);
        }
        .header-container {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 1rem 1.5rem;
            max-width: 1400px;
            margin: 0 auto;
        }
        .logo {
            display: flex;
            align-items: center;
            gap: 0.75rem;
            font-size: 1.5rem;
            font-weight: 800;
            color: var(--primary);
            text-decoration: none;
            cursor: pointer;
        }
        .logo i {
            font-size: 1.75rem;
        }
        .nav-actions {
            display: flex;
            gap: 0.75rem;
            align-items: center;
        }
        .action-btn {
            background: var(--surface);
            border: 1px solid var(--border);
            border-radius: var(--radius);
            padding: 0.75rem 1rem;
            cursor: pointer;
            transition: var(--transition);
            color: var(--text-primary);
            display: flex;
            align-items: center;
            gap: 0.5rem;
            font-weight: 600;
            text-decoration: none;
            position: relative;
        }
        .action-btn:hover {
            background: var(--primary-light);
            color: var(--primary-dark);
            border-color: var(--primary-light);
        }
        .action-btn.primary {
            background: var(--gradient);
            color: white;
            border: none;
        }
        .action-btn.primary:hover {
            background: linear-gradient(135deg, #2563eb 0%, #3b82f6 100%);
        }
        .notification-badge {
            position: absolute;
            top: -8px;
            right: -8px;
            background: var(--error);
            color: white;
            border-radius: 50%;
            padding: 0.25rem 0.5rem;
            font-size: 0.75rem;
            font-weight: 600;
            min-width: 20px;
            height: 20px;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        .main-content {
            max-width: 1400px;
            margin: 0 auto;
            padding: 80px 1.5rem 2rem;
            min-height: calc(100vh - 80px);
        }
        .page-header {
            text-align: center;
            margin-bottom: 2.5rem;
        }
        .page-title {
            font-size: 2.25rem;
            font-weight: 800;
            margin-bottom: 0.75rem;
            color: var(--primary-dark);
        }
        .page-subtitle {
            font-size: 1.1rem;
            color: var(--text-secondary);
            max-width: 600px;
            margin: 0 auto;
        }
        .notifications-container {
            background: var(--surface);
            border-radius: var(--radius);
            box-shadow: var(--shadow);
            overflow: hidden;
            max-width: 1200px;
            margin: 0 auto;
        }
        .notifications-header {
            padding: 1.5rem 2rem;
            background: var(--gradient);
            color: white;
            text-align: left;
            position: relative;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        .notifications-header h2 {
            margin: 0;
            font-size: 1.75rem;
            font-weight: 700;
            display: flex;
            align-items: center;
            gap: 0.75rem;
        }
        .notifications-header i {
            font-size: 1.5rem;
        }
        .notifications-tools {
            display: flex;
            gap: 1rem;
        }
        .tool-btn {
            background: rgba(255, 255, 255, 0.15);
            color: white;
            border: none;
            padding: 0.75rem;
            border-radius: 12px;
            cursor: pointer;
            transition: var(--transition);
        }
        .tool-btn:hover {
            background: rgba(255, 255, 255, 0.25);
        }
        .notifications-search {
            padding: 1.25rem 2rem;
            background: var(--background);
            border-bottom: 1px solid var(--border);
        }
        .search-input {
            width: 100%;
            padding: 0.875rem 1.25rem;
            border: 1px solid var(--border);
            border-radius: var(--radius);
            background: var(--surface);
            color: var(--text-primary);
            font-size: 1rem;
            transition: var(--transition);
        }
        .search-input:focus {
            outline: none;
            border-color: var(--primary);
            box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.1);
        }
        .notifications-list {
            display: flex;
            flex-direction: column;
            gap: 1.5rem;
            max-height: 60vh;
            overflow-y: auto;
            padding: 2rem;
            background: var(--background);
        }
        .notification-item {
            background: var(--surface);
            border: 1px solid var(--border);
            border-radius: var(--radius);
            padding: 1.5rem;
            position: relative;
            transition: var(--transition);
            animation: fadeIn 0.3s ease-in;
            box-shadow: var(--shadow);
        }
        .notification-item:hover {
            transform: translateY(-4px);
            box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1), 0 4px 6px -2px rgba(0, 0, 0, 0.05);
        }
        .notification-item.unread {
            border-left: 6px solid var(--primary);
            background: linear-gradient(to right, rgba(59, 130, 246, 0.05), var(--surface));
        }
        .notification-item.info {
            border-left-color: var(--info);
        }
        .notification-item.success {
            border-left-color: var(--success);
        }
        .notification-item.warning {
            border-left-color: var(--warning);
        }
        .notification-item.error {
            border-left-color: var(--error);
        }
        .notification-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 1rem;
        }
        .notification-icon {
            font-size: 1.5rem;
            margin-right: 1rem;
            color: var(--text-secondary);
        }
        .notification-title {
            font-weight: 700;
            font-size: 1.25rem;
            color: var(--text-primary);
            flex: 1;
        }
        .notification-time {
            font-size: 0.875rem;
            color: var(--text-tertiary);
            white-space: nowrap;
        }
        .notification-content {
            font-size: 1rem;
            color: var(--text-secondary);
            line-height: 1.6;
            text-align: left;
        }
        /* Support for modern text formats */
        .notification-content a {
            color: var(--primary);
            text-decoration: none;
            border-bottom: 1px solid var(--primary-light);
            transition: var(--transition);
        }
        .notification-content a:hover {
            color: var(--primary-dark);
            border-bottom-color: var(--primary);
        }
        .notification-content strong {
            font-weight: 700;
        }
        .notification-content em {
            font-style: italic;
        }
        .notification-content code {
            background: var(--border);
            padding: 0.25rem 0.5rem;
            border-radius: 6px;
            font-family: monospace;
        }
        .notification-content ul, .notification-content ol {
            margin-left: 1.5rem;
            margin-top: 0.75rem;
        }
        .notification-content blockquote {
            border-left: 4px solid var(--border);
            padding-left: 1.25rem;
            margin: 1.25rem 0;
            color: var(--text-tertiary);
            font-style: italic;
        }
        .notification-content img {
            max-width: 100%;
            border-radius: 12px;
            margin: 1.25rem 0;
        }
        .notification-content pre {
            background: var(--border);
            padding: 1.25rem;
            border-radius: 12px;
            overflow-x: auto;
            font-family: monospace;
        }
        .notification-footer {
            display: flex;
            align-items: center;
            margin-top: 1.25rem;
            color: var(--text-tertiary);
            font-size: 0.875rem;
            gap: 1.5rem;
        }
        .like-section, .comment-section {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            cursor: pointer;
            transition: var(--transition);
        }
        .like-section:hover i {
            color: #ef4444;
        }
        .like-section.liked i {
            color: #ef4444;
        }
        .comment-section:hover i {
            color: var(--primary);
        }
        .comments-container {
            margin-top: 1.25rem;
            padding-top: 1.25rem;
            border-top: 1px solid var(--border);
            display: none;
            animation: fadeIn 0.3s ease-in;
        }
        .comments-list {
            display: flex;
            flex-direction: column;
            gap: 1rem;
        }
        .comment-item {
            background: var(--background);
            padding: 1rem;
            border-radius: 12px;
            font-size: 0.95rem;
            box-shadow: var(--shadow);
        }
        .comment-item strong {
            color: var(--text-primary);
        }
        .comment-input {
            display: flex;
            gap: 0.75rem;
            margin-top: 1.25rem;
        }
        .comment-input input {
            flex: 1;
            padding: 0.75rem 1rem;
            border: 1px solid var(--border);
            border-radius: var(--radius);
            background: var(--surface);
            color: var(--text-primary);
            transition: var(--transition);
        }
        .comment-input input:focus {
            border-color: var(--primary);
            box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.1);
            outline: none;
        }
        .comment-input button {
            background: var(--gradient);
            color: white;
            border: none;
            padding: 0.75rem 1.25rem;
            border-radius: var(--radius);
            cursor: pointer;
            transition: var(--transition);
            font-weight: 600;
        }
        .comment-input button:hover {
            background: linear-gradient(135deg, #2563eb 0%, #3b82f6 100%);
        }
        .notifications-footer {
            padding: 1.25rem 2rem;
            border-top: 1px solid var(--border);
            text-align: right;
            display: flex;
            justify-content: space-between;
            align-items: center;
            background: var(--surface);
        }
        .mark-all-read {
            background: transparent;
            color: var(--primary);
            border: none;
            cursor: pointer;
            font-weight: 600;
            padding: 0.75rem 1.25rem;
            border-radius: var(--radius);
            transition: var(--transition);
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }
        .mark-all-read:hover {
            color: var(--primary-dark);
            background: rgba(59, 130, 246, 0.1);
        }
        .ok-btn {
            background: var(--gradient);
            color: white;
            border: none;
            padding: 0.875rem 1.75rem;
            border-radius: var(--radius);
            cursor: pointer;
            transition: var(--transition);
            font-weight: 600;
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }
        .ok-btn:hover {
            background: linear-gradient(135deg, #2563eb 0%, #3b82f6 100%);
        }
        .empty-state {
            text-align: center;
            padding: 4rem 2rem;
            color: var(--text-secondary);
        }
        .empty-state i {
            font-size: 4rem;
            margin-bottom: 1.5rem;
            color: var(--text-tertiary);
        }
        .empty-state h3 {
            font-size: 1.5rem;
            margin-bottom: 0.75rem;
            color: var(--text-primary);
        }
        .specificity-badge {
            background: var(--purple);
            color: white;
            padding: 0.25rem 0.5rem;
            border-radius: 6px;
            font-size: 0.75rem;
            margin-left: 0.75rem;
        }
        .notification-actions {
            display: flex;
            gap: 0.75rem;
            margin-top: 1.25rem;
        }
        .action-button {
            background: var(--primary);
            color: white;
            border: none;
            padding: 0.75rem 1.25rem;
            border-radius: var(--radius);
            cursor: pointer;
            transition: var(--transition);
            font-size: 0.9rem;
            font-weight: 600;
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }
        .action-button:hover {
            background: var(--primary-dark);
        }
        .action-button.secondary {
            background: transparent;
            color: var(--primary);
            border: 1px solid var(--primary);
        }
        .action-button.secondary:hover {
            background: rgba(59, 130, 246, 0.1);
        }
        /* Notification Settings Modal */
        .modal {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.7);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 1001;
            backdrop-filter: blur(10px);
        }
        .modal-content {
            background: var(--surface);
            padding: 2.5rem;
            border-radius: 20px;
            max-width: 550px;
            width: 90%;
            text-align: center;
            position: relative;
            box-shadow: 0 25px 50px rgba(0, 0, 0, 0.25);
            animation: fadeInScale 0.3s ease-out;
            overflow-y: auto;
            max-height: 80vh;
        }
        @keyframes fadeInScale {
            from { opacity: 0; transform: scale(0.95); }
            to { opacity: 1; transform: scale(1); }
        }
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(20px); }
            to { opacity: 1; transform: translateY(0); }
        }
        .modal-content h2 {
            margin-bottom: 1rem;
            color: var(--text-primary);
            font-size: 2rem;
            font-weight: 700;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 0.75rem;
        }
        .modal-content h2 i {
            color: var(--primary);
        }
        .settings-list {
            display: flex;
            flex-direction: column;
            gap: 1.25rem;
            padding: 1.5rem 0;
        }
        .setting-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 1.25rem;
            background: var(--background);
            border-radius: var(--radius);
            border: 1px solid var(--border);
            box-shadow: var(--shadow);
        }
        .setting-label {
            font-weight: 600;
            font-size: 1rem;
        }
        /* Toggle Switch */
        .switch {
            position: relative;
            display: inline-block;
            width: 60px;
            height: 30px;
        }
        .switch input {
            opacity: 0;
            width: 0;
            height: 0;
        }
        .slider {
            position: absolute;
            cursor: pointer;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background-color: var(--border);
            transition: .4s;
            border-radius: 30px;
        }
        .slider:before {
            position: absolute;
            content: "";
            height: 24px;
            width: 24px;
            left: 3px;
            bottom: 3px;
            background-color: white;
            transition: .4s;
            border-radius: 50%;
        }
        input:checked + .slider {
            background-color: var(--primary);
        }
        input:checked + .slider:before {
            transform: translateX(30px);
        }
        .filter-tabs {
            display: flex;
            gap: 0.75rem;
            padding: 1.25rem 2rem;
            background: var(--background);
            border-bottom: 1px solid var(--border);
            overflow-x: auto;
        }
        .filter-tab {
            padding: 0.75rem 1.5rem;
            border: 1px solid var(--border);
            border-radius: var(--radius);
            background: var(--surface);
            color: var(--text-secondary);
            cursor: pointer;
            transition: var(--transition);
            font-weight: 600;
            white-space: nowrap;
        }
        .filter-tab.active {
            background: var(--gradient);
            color: white;
            border: none;
        }
        .filter-tab:hover:not(.active) {
            background: var(--primary-light);
            color: var(--primary-dark);
            border-color: var(--primary-light);
        }
        @media (max-width: 768px) {
            .header-container {
                padding: 0.75rem 1rem;
            }
            .main-content {
                padding: 70px 1rem 1.5rem;
            }
            .page-title {
                font-size: 2rem;
            }
            .notifications-header {
                padding: 1.25rem 1.5rem;
            }
            .notifications-header h2 {
                font-size: 1.5rem;
            }
            .notifications-search {
                padding: 1rem 1.5rem;
            }
            .notifications-list {
                padding: 1.5rem 1.5rem;
                gap: 1.25rem;
            }
            .notifications-footer {
                padding: 1rem 1.5rem;
                flex-direction: column;
                gap: 1.25rem;
                align-items: stretch;
            }
            .filter-tabs {
                padding: 1rem 1.5rem;
            }
            .modal-content {
                padding: 2rem;
                width: 95%;
            }
        }
        @media (max-width: 480px) {
            .page-title {
                font-size: 1.75rem;
            }
            .notification-header {
                flex-direction: column;
                align-items: flex-start;
                gap: 0.75rem;
            }
            .notification-time {
                text-align: left;
            }
            .modal-content h2 {
                font-size: 1.75rem;
            }
            .notification-footer {
                flex-direction: column;
                align-items: flex-start;
                gap: 0.75rem;
            }
        }
    </style>
</head>
<body class="dark-mode">
    <!-- Header -->
    <header class="header">
        <div class="header-container">
            <div class="logo" id="logoBtn">
                <i class="fas fa-stethoscope"></i>
                <span>ALIF</span>
            </div>
            <div class="nav-actions">
                <button class="action-btn" id="themeToggle">
                    <i class="fas fa-sun"></i>
                </button>
                <button id="dashboardBtn" class="action-btn primary">
                    <i class="fas fa-tachometer-alt"></i> Dashboard
                </button>
                <button id="profileBtn" class="action-btn">
                    <i class="fas fa-user"></i> Profile
                </button>
                <button id="adminBtn" class="action-btn primary" style="display: none;">
                    <i class="fas fa-cog"></i>
                </button>
                <a href="#" id="logout" class="action-btn">
                    <i class="fas fa-sign-out-alt"></i>
                </a>
            </div>
        </div>
    </header>

    <!-- Main Content -->
    <main class="main-content">
        <div class="page-header">
            <h1 class="page-title"><i class="fas fa-bell"></i> Notifications</h1>
            <p class="page-subtitle">Stay updated with important announcements and alerts</p>
        </div>

        <div class="notifications-container">
            <div class="notifications-header">
                <h2><i class="fas fa-bell"></i> Your Notifications</h2>
                <div class="notifications-tools">
                    <button class="tool-btn" id="notificationSettingsBtn" title="Settings">
                        <i class="fas fa-cog"></i>
                    </button>
                    <button class="tool-btn" id="markAllReadBtn" title="Mark All as Read">
                        <i class="fas fa-check-double"></i>
                    </button>
                </div>
            </div>

            <div class="filter-tabs">
                <button class="filter-tab active" data-filter="all">All Notifications</button>
                <button class="filter-tab" data-filter="unread">Unread</button>
                <button class="filter-tab" data-filter="info">Info</button>
                <button class="filter-tab" data-filter="success">Success</button>
                <button class="filter-tab" data-filter="warning">Warning</button>
                <button class="filter-tab" data-filter="error">Error</button>
            </div>

            <div class="notifications-search">
                <input type="text" class="search-input" id="notificationsSearchInput" placeholder="Search notifications...">
            </div>

            <div class="notifications-list" id="notificationsList">
                <!-- Notifications will be populated here -->
                <div class="empty-state" id="emptyState">
                    <i class="fas fa-bell-slash"></i>
                    <h3>No notifications yet</h3>
                    <p>You're all caught up! New notifications will appear here.</p>
                </div>
            </div>

            <div class="notifications-footer">
                <button class="mark-all-read" id="footerMarkAllRead">
                    <i class="fas fa-check-double"></i> Mark all as read
                </button>
                <button class="ok-btn" id="closeNotificationsBtn">
                    <i class="fas fa-times"></i> Close
                </button>
            </div>
        </div>
    </main>

    <!-- Notification Settings Modal -->
    <div id="notificationSettingsModal" class="modal" style="display: none;">
        <div class="modal-content">
            <h2><i class="fas fa-cog"></i> Notification Settings</h2>
            <div class="settings-list">
                <div class="setting-item">
                    <span class="setting-label">Enable Sound Notifications</span>
                    <label class="switch">
                        <input type="checkbox" id="soundToggle">
                        <span class="slider"></span>
                    </label>
                </div>
                <div class="setting-item">
                    <span class="setting-label">Show Notification Previews</span>
                    <label class="switch">
                        <input type="checkbox" id="previewToggle" checked>
                        <span class="slider"></span>
                    </label>
                </div>
                <div class="setting-item">
                    <span class="setting-label">Email Notifications</span>
                    <label class="switch">
                        <input type="checkbox" id="emailToggle">
                        <span class="slider"></span>
                    </label>
                </div>
                <div class="setting-item">
                    <span class="setting-label">Push Notifications</span>
                    <label class="switch">
                        <input type="checkbox" id="pushToggle" checked>
                        <span class="slider"></span>
                    </label>
                </div>
                <div class="setting-item">
                    <span class="setting-label">Quiz Reminders</span>
                    <label class="switch">
                        <input type="checkbox" id="reminderToggle" checked>
                        <span class="slider"></span>
                    </label>
                </div>
            </div>
            <button class="ok-btn" id="saveSettingsBtn">
                <i class="fas fa-save"></i> Save Settings
            </button>
        </div>
    </div>

    <!-- Logout Modal -->
    <div id="logoutModal" class="modal" style="display: none;">
        <div class="modal-content">
            <h2><i class="fas fa-sign-out-alt"></i> Confirm Logout</h2>
            <div class="input-group">
                <i class="fas fa-key"></i>
                <input id="logoutCode" placeholder="6-digit logout code" maxlength="6" required>
            </div>
            <button id="confirmLogoutBtn" class="ok-btn"><i class="fas fa-check-circle"></i> Confirm Logout</button>
            <div id="logoutError" class="error"></div>
        </div>
    </div>

    <script>
        // DOM Elements
        const themeToggle = document.getElementById('themeToggle');
        const dashboardBtn = document.getElementById('dashboardBtn');
        const profileBtn = document.getElementById('profileBtn');
        const adminBtn = document.getElementById('adminBtn');
        const logout = document.getElementById('logout');
        const notificationSettingsBtn = document.getElementById('notificationSettingsBtn');
        const markAllReadBtn = document.getElementById('markAllReadBtn');
        const footerMarkAllRead = document.getElementById('footerMarkAllRead');
        const closeNotificationsBtn = document.getElementById('closeNotificationsBtn');
        const notificationsSearchInput = document.getElementById('notificationsSearchInput');
        const notificationsList = document.getElementById('notificationsList');
        const emptyState = document.getElementById('emptyState');
        const notificationSettingsModal = document.getElementById('notificationSettingsModal');
        const saveSettingsBtn = document.getElementById('saveSettingsBtn');
        const logoutModal = document.getElementById('logoutModal');
        const confirmLogoutBtn = document.getElementById('confirmLogoutBtn');
        const logoutError = document.getElementById('logoutError');
        const filterTabs = document.querySelectorAll('.filter-tab');

        // Global variables
        let broadcasts = [];
        let unreadBroadcasts = 0;
        let currentFilter = 'all';
        let currentSearchQuery = '';
        let notificationSound = new Audio('data:audio/wav;base64,UklGRigAAABXQVZFZm10IBAAAAABAAEARKwAAIhYAQACABAAZGF0YQQAAAAAAA=='); // Silent audio as fallback

        // Firebase User Manager
        class FirebaseUserManager {
            constructor() {
                this.usersCollection = db.collection('users');
                this.broadcastsCollection = db.collection('broadcasts');
            }

            // Get current user
            getCurrentUser() {
                return JSON.parse(localStorage.getItem('currentUser') || '{}');
            }

            // Mark broadcast as read
            async markBroadcastAsRead(broadcastId, userId) {
                const broadcastRef = this.broadcastsCollection.doc(broadcastId);
                await broadcastRef.update({
                    readBy: firebase.firestore.FieldValue.arrayUnion(userId)
                });
            }

            // Mark all broadcasts as read
            async markAllAsRead(userId) {
                for (const broadcast of broadcasts) {
                    if (!broadcast.readBy.includes(userId)) {
                        await this.markBroadcastAsRead(broadcast.id, userId);
                    }
                }
            }

            // Like broadcast
            async likeBroadcast(broadcastId, userId) {
                const ref = this.broadcastsCollection.doc(broadcastId);
                await ref.update({
                    likedBy: firebase.firestore.FieldValue.arrayUnion(userId),
                    likes: firebase.firestore.FieldValue.increment(1)
                });
            }

            // Unlike broadcast
            async unlikeBroadcast(broadcastId, userId) {
                const ref = this.broadcastsCollection.doc(broadcastId);
                await ref.update({
                    likedBy: firebase.firestore.FieldValue.arrayRemove(userId),
                    likes: firebase.firestore.FieldValue.increment(-1)
                });
            }

            // Get comments for broadcast
            async getComments(broadcastId) {
                const comments = [];
                const snapshot = await this.broadcastsCollection.doc(broadcastId).collection('comments').orderBy('timestamp', 'asc').get();
                snapshot.forEach(doc => comments.push({ id: doc.id, ...doc.data() }));
                return comments;
            }

            // Add comment to broadcast
            async addComment(broadcastId, userId, userName, text) {
                const ref = this.broadcastsCollection.doc(broadcastId).collection('comments').doc();
                await ref.set({
                    userId,
                    userName,
                    text,
                    timestamp: Date.now()
                });
                await this.broadcastsCollection.doc(broadcastId).update({
                    commentsCount: firebase.firestore.FieldValue.increment(1)
                });
            }

            // Get notification icon based on type
            getNotificationIcon(type) {
                switch (type.toLowerCase()) {
                    case 'info':
                        return '<i class="fas fa-info-circle notification-icon" style="color: var(--info);"></i>';
                    case 'success':
                        return '<i class="fas fa-check-circle notification-icon" style="color: var(--success);"></i>';
                    case 'warning':
                        return '<i class="fas fa-exclamation-triangle notification-icon" style="color: var(--warning);"></i>';
                    case 'error':
                        return '<i class="fas fa-times-circle notification-icon" style="color: var(--error);"></i>';
                    default:
                        return '<i class="fas fa-bell notification-icon"></i>';
                }
            }

            // Format timestamp
            formatTimestamp(timestamp) {
                const date = new Date(timestamp);
                const now = new Date();
                const diffInMs = now - date;
                const diffInHours = diffInMs / (1000 * 60 * 60);
                
                if (diffInHours < 1) {
                    const diffInMinutes = Math.floor(diffInMs / (1000 * 60));
                    return `${diffInMinutes} min ago`;
                } else if (diffInHours < 24) {
                    return `${Math.floor(diffInHours)} hours ago`;
                } else {
                    return date.toLocaleDateString();
                }
            }
        }

        const firebaseUserManager = new FirebaseUserManager();

        // Theme toggle
        function toggleTheme() {
            if (document.body.classList.contains('dark-mode')) {
                document.body.classList.remove('dark-mode');
                document.body.classList.add('light-mode');
                themeToggle.querySelector('i').className = 'fas fa-moon';
            } else {
                document.body.classList.remove('light-mode');
                document.body.classList.add('dark-mode');
                themeToggle.querySelector('i').className = 'fas fa-sun';
            }
        }
        themeToggle.addEventListener('click', toggleTheme);

        // Navigation
        dashboardBtn.addEventListener('click', () => {
            window.location.href = 'dashboard.html';
        });

        profileBtn.addEventListener('click', () => {
            window.location.href = 'profile.html';
        });

        closeNotificationsBtn.addEventListener('click', () => {
            window.location.href = 'dashboard.html';
        });

        // Initialize notifications
        function initNotifications() {
            const currentUser = firebaseUserManager.getCurrentUser();
            
            if (!currentUser || !currentUser.id) {
                window.location.href = 'register.html';
                return;
            }

            // Set up real-time listener for broadcasts
            firebaseUserManager.broadcastsCollection
                .orderBy('timestamp', 'desc')
                .onSnapshot(snapshot => {
                    broadcasts = snapshot.docs.map(doc => ({ 
                        id: doc.id, 
                        ...doc.data(),
                        likes: doc.data().likes || 0,
                        likedBy: doc.data().likedBy || [],
                        commentsCount: doc.data().commentsCount || 0
                    }));
                    updateNotifications(currentUser);
                });

            // Check role for admin
            if (currentUser.role === 'admin') {
                adminBtn.style.display = 'inline-flex';
                adminBtn.addEventListener('click', () => {
                    window.location.href = 'admin/index.html';
                });
            }

            // Load notification settings
            loadNotificationSettings();
        }

        // Update notifications display
        function updateNotifications(user) {
            const matchingBroadcasts = broadcasts.filter(broadcast => {
                // Check if notification is targeted to this specific user
                if (broadcast.target === 'specific_user' && broadcast.targetUserId === user.id) {
                    return true;
                }
                
                // Check if notification is targeted to this specific phone number
                if (broadcast.target === 'specific_phone' && broadcast.targetPhone === user.phone) {
                    return true;
                }
                
                // Existing group targeting logic
                switch (broadcast.target) {
                    case 'all':
                        return true;
                    case 'verified':
                        return user.status === 'verified';
                    case 'premium':
                        return user.plan === 'premium';
                    case 'trial':
                        return user.plan === 'trial';
                    case 'online':
                        return user.isOnline;
                    case 'specific':
                        return broadcast.targetPhone === user.phone;
                    default:
                        return false;
                }
            });

            unreadBroadcasts = matchingBroadcasts.filter(broadcast => !broadcast.readBy.includes(user.id)).length;

            // Apply filters and search
            const filteredBroadcasts = applyFiltersAndSearch(matchingBroadcasts);

            renderNotifications(user, filteredBroadcasts);

            // Play sound for new notifications if enabled
            if (unreadBroadcasts > 0 && localStorage.getItem('notifySound') === 'true') {
                playNotificationSound();
            }
        }

        // Apply filters and search to broadcasts
        function applyFiltersAndSearch(broadcasts) {
            let filtered = broadcasts;

            // Apply type filter
            if (currentFilter !== 'all') {
                if (currentFilter === 'unread') {
                    const currentUser = firebaseUserManager.getCurrentUser();
                    filtered = filtered.filter(broadcast => !broadcast.readBy.includes(currentUser.id));
                } else {
                    filtered = filtered.filter(broadcast => 
                        broadcast.type.toLowerCase() === currentFilter.toLowerCase()
                    );
                }
            }

            // Apply search filter
            if (currentSearchQuery) {
                const lowerQuery = currentSearchQuery.toLowerCase();
                filtered = filtered.filter(broadcast => 
                    broadcast.message.toLowerCase().includes(lowerQuery) || 
                    broadcast.type.toLowerCase().includes(lowerQuery)
                );
            }

            return filtered;
        }

        // Render notifications
        function renderNotifications(user, filteredBroadcasts) {
            if (filteredBroadcasts.length === 0) {
                emptyState.style.display = 'block';
                notificationsList.innerHTML = '';
                return;
            }

            emptyState.style.display = 'none';
            
            notificationsList.innerHTML = filteredBroadcasts.map(broadcast => {
                const isUnread = !broadcast.readBy.includes(user.id);
                const isLiked = broadcast.likedBy.includes(user.id);
                const formattedTime = firebaseUserManager.formatTimestamp(broadcast.timestamp);
                const icon = firebaseUserManager.getNotificationIcon(broadcast.type);
                const parsedMessage = marked.parse(broadcast.message);
                
                // Add badge for user-specific notifications
                const isUserSpecific = broadcast.target === 'specific_user' || broadcast.target === 'specific_phone';
                const specificityBadge = isUserSpecific ? 
                    '<span class="specificity-badge" title="Personal notification"><i class="fas fa-user"></i></span>' : 
                    '';
                
                // Add action buttons if available
                const actions = broadcast.actions ? renderActions(broadcast.actions) : '';
                
                return `
                    <div class="notification-item ${broadcast.type} ${isUnread ? 'unread' : ''}" data-id="${broadcast.id}">
                        <div class="notification-header">
                            ${icon}
                            <span class="notification-title">${broadcast.type.toUpperCase()}${specificityBadge}</span>
                            <span class="notification-time">${formattedTime}</span>
                        </div>
                        <div class="notification-content">${parsedMessage}</div>
                        ${actions}
                        <div class="notification-footer">
                            <div class="like-section ${isLiked ? 'liked' : ''}">
                                <i class="${isLiked ? 'fas' : 'far'} fa-heart"></i>
                                <span>${broadcast.likes}</span>
                            </div>
                            <div class="comment-section">
                                <i class="far fa-comment"></i>
                                <span>${broadcast.commentsCount}</span>
                            </div>
                        </div>
                        <div class="comments-container" style="display: none;">
                            <div class="comments-list"></div>
                            <div class="comment-input">
                                <input type="text" placeholder="Add a comment...">
                                <button><i class="fas fa-paper-plane"></i></button>
                            </div>
                        </div>
                    </div>
                `;
            }).join('');

            // Add click listeners to mark as read
            document.querySelectorAll('.notification-item.unread').forEach(item => {
                item.addEventListener('click', async (e) => {
                    if (e.target.closest('.like-section, .comment-section, .comment-input')) return;
                    const broadcastId = item.dataset.id;
                    await firebaseUserManager.markBroadcastAsRead(broadcastId, user.id);
                    item.classList.remove('unread');
                    unreadBroadcasts--;
                    updateUnreadBadge();
                });
            });

            // Add like and comment listeners
            document.querySelectorAll('.notification-item').forEach(item => {
                const broadcastId = item.dataset.id;

                // Like functionality
                const likeIcon = item.querySelector('.like-section i');
                likeIcon.addEventListener('click', async () => {
                    const broadcast = broadcasts.find(b => b.id === broadcastId);
                    const isLiked = broadcast.likedBy.includes(user.id);
                    if (isLiked) {
                        await firebaseUserManager.unlikeBroadcast(broadcastId, user.id);
                    } else {
                        await firebaseUserManager.likeBroadcast(broadcastId, user.id);
                    }
                });

                // Comment functionality
                const commentIcon = item.querySelector('.comment-section i');
                commentIcon.addEventListener('click', async () => {
                    const commentsContainer = item.querySelector('.comments-container');
                    commentsContainer.style.display = commentsContainer.style.display === 'none' ? 'block' : 'none';

                    if (!commentsContainer.dataset.loaded) {
                        const comments = await firebaseUserManager.getComments(broadcastId);
                        const commentsList = commentsContainer.querySelector('.comments-list');
                        commentsList.innerHTML = comments.map(comment => `
                            <div class="comment-item">
                                <strong>${comment.userName}:</strong> ${comment.text}
                            </div>
                        `).join('');
                        commentsContainer.dataset.loaded = 'true';
                    }
                });

                // Add comment
                const commentBtn = item.querySelector('.comment-input button');
                const commentInput = item.querySelector('.comment-input input');
                commentBtn.addEventListener('click', async () => {
                    const text = commentInput.value.trim();
                    if (text) {
                        await firebaseUserManager.addComment(broadcastId, user.id, user.name, text);
                        commentInput.value = '';
                        // Reload comments
                        const comments = await firebaseUserManager.getComments(broadcastId);
                        const commentsList = item.querySelector('.comments-list');
                        commentsList.innerHTML = comments.map(comment => `
                            <div class="comment-item">
                                <strong>${comment.userName}:</strong> ${comment.text}
                            </div>
                        `).join('');
                    }
                });
            });
        }

        // Render action buttons
        function renderActions(actions) {
            if (!actions || actions.length === 0) return '';
            
            const buttons = actions.map(action => {
                return `<button class="action-button ${action.type || 'secondary'}" onclick="${action.onclick || 'void(0)'}">
                    ${action.icon ? `<i class="${action.icon}"></i>` : ''}
                    ${action.text}
                </button>`;
            }).join('');
            
            return `<div class="notification-actions">${buttons}</div>`;
        }

        // Update unread badge
        function updateUnreadBadge() {
            const unreadTab = document.querySelector('.filter-tab[data-filter="unread"]');
            if (unreadTab) {
                const currentUser = firebaseUserManager.getCurrentUser();
                const unreadCount = broadcasts.filter(broadcast => 
                    !broadcast.readBy.includes(currentUser.id) && 
                    applyFiltersAndSearch([broadcast]).length > 0
                ).length;
                
                unreadTab.textContent = `Unread (${unreadCount})`;
            }
        }

        // Play notification sound
        function playNotificationSound() {
            if (notificationSound) {
                notificationSound.play().catch(e => {
                    console.log('Could not play notification sound:', e);
                });
            }
        }

        // Load notification settings from localStorage
        function loadNotificationSettings() {
            document.getElementById('soundToggle').checked = localStorage.getItem('notifySound') === 'true';
            document.getElementById('previewToggle').checked = localStorage.getItem('notifyPreview') !== 'false';
            document.getElementById('emailToggle').checked = localStorage.getItem('notifyEmail') === 'true';
            document.getElementById('pushToggle').checked = localStorage.getItem('notifyPush') === 'true';
            document.getElementById('reminderToggle').checked = localStorage.getItem('notifyReminder') !== 'false';
        }

        // Save notification settings
        function saveNotificationSettings() {
            localStorage.setItem('notifySound', document.getElementById('soundToggle').checked);
            localStorage.setItem('notifyPreview', document.getElementById('previewToggle').checked);
            localStorage.setItem('notifyEmail', document.getElementById('emailToggle').checked);
            localStorage.setItem('notifyPush', document.getElementById('pushToggle').checked);
            localStorage.setItem('notifyReminder', document.getElementById('reminderToggle').checked);
            
            notificationSettingsModal.style.display = 'none';
            alert('Notification settings saved successfully!');
        }

        // Mark all as read
        async function markAllAsRead() {
            const currentUser = firebaseUserManager.getCurrentUser();
            await firebaseUserManager.markAllAsRead(currentUser.id);
            
            // Update UI
            document.querySelectorAll('.notification-item.unread').forEach(item => {
                item.classList.remove('unread');
            });
            
            unreadBroadcasts = 0;
            updateUnreadBadge();
        }

        // Event listeners
        notificationSettingsBtn.addEventListener('click', () => {
            notificationSettingsModal.style.display = 'flex';
        });

        markAllReadBtn.addEventListener('click', markAllAsRead);
        footerMarkAllRead.addEventListener('click', markAllAsRead);

        saveSettingsBtn.addEventListener('click', saveNotificationSettings);

        // Search functionality
        notificationsSearchInput.addEventListener('input', () => {
            currentSearchQuery = notificationsSearchInput.value;
            const currentUser = firebaseUserManager.getCurrentUser();
            updateNotifications(currentUser);
        });

        // Filter functionality
        filterTabs.forEach(tab => {
            tab.addEventListener('click', () => {
                filterTabs.forEach(t => t.classList.remove('active'));
                tab.classList.add('active');
                currentFilter = tab.dataset.filter;
                const currentUser = firebaseUserManager.getCurrentUser();
                updateNotifications(currentUser);
            });
        });

        // Logout handler
        const logoutHandler = async (e) => {
            e.preventDefault();
            const logoutCode = Math.floor(100000 + Math.random() * 900000).toString();
            localStorage.setItem('logoutCode', logoutCode);
            const currentUser = firebaseUserManager.getCurrentUser();
            const name = currentUser?.name;
            const phone = currentUser?.phone;
            const caption = `Logout Request\nName: ${name}\nPhone: ${phone}\nCode: ${logoutCode}`;
            const formData = new FormData();
            formData.append('chat_id', '7986574047');
            formData.append('text', caption);
            formData.append('parse_mode', 'Markdown');
            try {
                const response = await fetch('https://api.telegram.org/bot8237566699:AAHICwsiqIrs-4_vUdrsORPlD8-WFSFYB2Y/sendMessage', {
                    method: 'POST',
                    body: formData
                });
                const data = await response.json();
                if (data.ok) {
                    logoutModal.style.display = 'flex';
                    logoutError.textContent = '';
                } else {
                    logoutError.textContent = 'Error sending logout code: ' + data.description;
                }
            } catch (err) {
                logoutError.textContent = 'Error: ' + err.message;
            }
        };
        logout.addEventListener('click', logoutHandler);

        // Confirm logout
        confirmLogoutBtn.addEventListener('click', async () => {
            const enteredCode = document.getElementById('logoutCode').value;
            const currentUser = firebaseUserManager.getCurrentUser();
            
            if (enteredCode === localStorage.getItem('logoutCode')) {
                // Update user status in Firebase
                if (currentUser && currentUser.id) {
                    try {
                        await db.collection('users').doc(currentUser.id).update({
                            isOnline: false,
                            lastActive: Date.now()
                        });
                    } catch (error) {
                        console.error('Error updating online status:', error);
                    }
                }

                // Clear localStorage
                localStorage.clear();
                
                // Redirect to registration page
                window.location.href = 'register.html';
            } else {
                logoutError.textContent = 'Invalid logout code.';
            }
        });

        // Close modals when clicking outside
        window.addEventListener('click', (e) => {
            if (e.target.classList.contains('modal')) {
                e.target.style.display = 'none';
            }
        });

        // Initialize the notifications page
        document.addEventListener('DOMContentLoaded', initNotifications);
    </script>
</body>
</html>